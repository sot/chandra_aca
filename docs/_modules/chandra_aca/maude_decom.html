
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>chandra_aca.maude_decom &#8212; chandra_aca 4.31.0 documentation</title>
    <link rel="stylesheet" href="../../_static/bootstrap-astropy.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../_static/copybutton.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../index.html"><span id="logotext1">Ska! </span><span id="logotext2">chandra_aca</span><span id="logotext3"></span></a>
  <ul>
    
    <li><a class="home" title="Homepage" href="https://cxc.cfa.harvard.edu/mta/ASPECT/tool_doc">
        <span id="logotext1">ska</span><span id="logotext2">tools</span>
    </a></li>
    <li><a title="General Index" href="../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../index.html">chandra_aca 4.31.0 documentation</a>
	 &#187;
      </li>
      <li><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for chandra_aca.maude_decom</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Classes and functions to help fetching ACA telemetry data using MAUDE.</span>
<span class="sd">These include the following global variables</span>

<span class="sd">    * PIXEL_MAP: dict of np.array, with values mapping integer pixel indices to pixel string ID</span>
<span class="sd">    * PIXEL_MAP_INV: dict of dict, with values mapping pixel string ID to integer pixel indices.</span>
<span class="sd">    * PIXEL_MASK: dict of np.array. Values are boolean masks that apply to images of different sizes</span>
<span class="sd">    * ACA_MSID_LIST: dictionary of commonly-used ACA telemetry MSIDs.</span>
<span class="sd">    * ACA_SLOT_MSID_LIST: dictionary of ACA image telemetry MSIDs.</span>

<span class="sd">PIXEL_MAP contains maps between pixel indices and pixel IDm depending on the image size.</span>
<span class="sd">In the following tables, column index increases to the right and row index increases to the top</span>
<span class="sd">(c.f. ACA User Manual Figs 1.8 and 1.9 )::</span>

<span class="sd">  - Size 4X41:</span>

<span class="sd">    -----------------------------------------</span>
<span class="sd">    | -- | -- | -- | -- | -- | -- | -- | -- |</span>
<span class="sd">    -----------------------------------------</span>
<span class="sd">    | -- | -- | -- | -- | -- | -- | -- | -- |</span>
<span class="sd">    -----------------------------------------</span>
<span class="sd">    | -- | -- | D1 | H1 | L1 | P1 | -- | -- |</span>
<span class="sd">    -----------------------------------------</span>
<span class="sd">    | -- | -- | C1 | G1 | K1 | O1 | -- | -- |</span>
<span class="sd">    -----------------------------------------</span>
<span class="sd">    | -- | -- | B1 | F1 | J1 | N1 | -- | -- |</span>
<span class="sd">    -----------------------------------------</span>
<span class="sd">    | -- | -- | A1 | E1 | I1 | M1 | -- | -- |</span>
<span class="sd">    -----------------------------------------</span>
<span class="sd">    | -- | -- | -- | -- | -- | -- | -- | -- |</span>
<span class="sd">    -----------------------------------------</span>
<span class="sd">    | -- | -- | -- | -- | -- | -- | -- | -- |</span>
<span class="sd">    -----------------------------------------</span>

<span class="sd">  - Size 6X61 or 6X62:</span>

<span class="sd">    -----------------------------------------</span>
<span class="sd">    | -- | -- | -- | -- | -- | -- | -- | -- |</span>
<span class="sd">    -----------------------------------------</span>
<span class="sd">    | -- | -- | E2 | F2 | G2 | H2 | -- | -- |</span>
<span class="sd">    -----------------------------------------</span>
<span class="sd">    | -- | D2 | D1 | H1 | L1 | P1 | I2 | -- |</span>
<span class="sd">    -----------------------------------------</span>
<span class="sd">    | -- | C2 | C1 | G1 | K1 | O1 | J2 | -- |</span>
<span class="sd">    -----------------------------------------</span>
<span class="sd">    | -- | B2 | B1 | F1 | J1 | N1 | K2 | -- |</span>
<span class="sd">    -----------------------------------------</span>
<span class="sd">    | -- | A2 | A1 | E1 | I1 | M1 | L2 | -- |</span>
<span class="sd">    -----------------------------------------</span>
<span class="sd">    | -- | -- | P2 | O2 | N2 | M2 | -- | -- |</span>
<span class="sd">    -----------------------------------------</span>
<span class="sd">    | -- | -- | -- | -- | -- | -- | -- | -- |</span>
<span class="sd">    -----------------------------------------</span>


<span class="sd">  - Size 8X81, 8X82, 8X83 or 8X84:</span>

<span class="sd">    -----------------------------------------</span>
<span class="sd">    | H1 | P1 | H2 | P2 | H3 | P3 | H4 | P4 |</span>
<span class="sd">    -----------------------------------------</span>
<span class="sd">    | G1 | O1 | G2 | O2 | G3 | O3 | G4 | O4 |</span>
<span class="sd">    -----------------------------------------</span>
<span class="sd">    | F1 | N1 | F2 | N2 | F3 | N3 | F4 | N4 |</span>
<span class="sd">    -----------------------------------------</span>
<span class="sd">    | E1 | M1 | E2 | M2 | E3 | M3 | E4 | M4 |</span>
<span class="sd">    -----------------------------------------</span>
<span class="sd">    | D1 | L1 | D2 | L2 | D3 | L3 | D4 | L4 |</span>
<span class="sd">    -----------------------------------------</span>
<span class="sd">    | C1 | K1 | C2 | K2 | C3 | K3 | C4 | K4 |</span>
<span class="sd">    -----------------------------------------</span>
<span class="sd">    | B1 | J1 | B2 | J2 | B3 | J3 | B4 | J4 |</span>
<span class="sd">    -----------------------------------------</span>
<span class="sd">    | A1 | I1 | A2 | I2 | A3 | I3 | A4 | I4 |</span>
<span class="sd">    -----------------------------------------</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">unpack</span> <span class="k">as</span> <span class="n">_unpack</span><span class="p">,</span> <span class="n">Struct</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">vstack</span>
<span class="kn">import</span> <span class="nn">maude</span>

<span class="kn">from</span> <span class="nn">Chandra.Time</span> <span class="kn">import</span> <span class="n">DateTime</span>

<span class="c1"># The following are the tables in the docstring above. They appear to be transposed,</span>
<span class="c1"># but the resultt agrees with level0.</span>
<span class="n">PIXEL_MAP</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;4x4&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">],</span>
                     <span class="p">[</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">],</span>
                     <span class="p">[</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;A1&#39;</span><span class="p">,</span> <span class="s1">&#39;B1&#39;</span><span class="p">,</span> <span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="s1">&#39;D1&#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">],</span>
                     <span class="p">[</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;E1&#39;</span><span class="p">,</span> <span class="s1">&#39;F1&#39;</span><span class="p">,</span> <span class="s1">&#39;G1&#39;</span><span class="p">,</span> <span class="s1">&#39;H1&#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">],</span>
                     <span class="p">[</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;I1&#39;</span><span class="p">,</span> <span class="s1">&#39;J1&#39;</span><span class="p">,</span> <span class="s1">&#39;K1&#39;</span><span class="p">,</span> <span class="s1">&#39;L1&#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">],</span>
                     <span class="p">[</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;M1&#39;</span><span class="p">,</span> <span class="s1">&#39;N1&#39;</span><span class="p">,</span> <span class="s1">&#39;O1&#39;</span><span class="p">,</span> <span class="s1">&#39;P1&#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">],</span>
                     <span class="p">[</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">],</span>
                     <span class="p">[</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">]]),</span>
    <span class="s1">&#39;6x6&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">],</span>
                     <span class="p">[</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;A2&#39;</span><span class="p">,</span> <span class="s1">&#39;B2&#39;</span><span class="p">,</span> <span class="s1">&#39;C2&#39;</span><span class="p">,</span> <span class="s1">&#39;D2&#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">],</span>
                     <span class="p">[</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;P2&#39;</span><span class="p">,</span> <span class="s1">&#39;A1&#39;</span><span class="p">,</span> <span class="s1">&#39;B1&#39;</span><span class="p">,</span> <span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="s1">&#39;D1&#39;</span><span class="p">,</span> <span class="s1">&#39;E2&#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">],</span>
                     <span class="p">[</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;O2&#39;</span><span class="p">,</span> <span class="s1">&#39;E1&#39;</span><span class="p">,</span> <span class="s1">&#39;F1&#39;</span><span class="p">,</span> <span class="s1">&#39;G1&#39;</span><span class="p">,</span> <span class="s1">&#39;H1&#39;</span><span class="p">,</span> <span class="s1">&#39;F2&#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">],</span>
                     <span class="p">[</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;N2&#39;</span><span class="p">,</span> <span class="s1">&#39;I1&#39;</span><span class="p">,</span> <span class="s1">&#39;J1&#39;</span><span class="p">,</span> <span class="s1">&#39;K1&#39;</span><span class="p">,</span> <span class="s1">&#39;L1&#39;</span><span class="p">,</span> <span class="s1">&#39;G2&#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">],</span>
                     <span class="p">[</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;M2&#39;</span><span class="p">,</span> <span class="s1">&#39;M1&#39;</span><span class="p">,</span> <span class="s1">&#39;N1&#39;</span><span class="p">,</span> <span class="s1">&#39;O1&#39;</span><span class="p">,</span> <span class="s1">&#39;P1&#39;</span><span class="p">,</span> <span class="s1">&#39;H2&#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">],</span>
                     <span class="p">[</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;L2&#39;</span><span class="p">,</span> <span class="s1">&#39;K2&#39;</span><span class="p">,</span> <span class="s1">&#39;J2&#39;</span><span class="p">,</span> <span class="s1">&#39;I2&#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">],</span>
                     <span class="p">[</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">]]),</span>
    <span class="s1">&#39;8x8&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="s1">&#39;A1&#39;</span><span class="p">,</span> <span class="s1">&#39;B1&#39;</span><span class="p">,</span> <span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="s1">&#39;D1&#39;</span><span class="p">,</span> <span class="s1">&#39;E1&#39;</span><span class="p">,</span> <span class="s1">&#39;F1&#39;</span><span class="p">,</span> <span class="s1">&#39;G1&#39;</span><span class="p">,</span> <span class="s1">&#39;H1&#39;</span><span class="p">],</span>
                     <span class="p">[</span><span class="s1">&#39;I1&#39;</span><span class="p">,</span> <span class="s1">&#39;J1&#39;</span><span class="p">,</span> <span class="s1">&#39;K1&#39;</span><span class="p">,</span> <span class="s1">&#39;L1&#39;</span><span class="p">,</span> <span class="s1">&#39;M1&#39;</span><span class="p">,</span> <span class="s1">&#39;N1&#39;</span><span class="p">,</span> <span class="s1">&#39;O1&#39;</span><span class="p">,</span> <span class="s1">&#39;P1&#39;</span><span class="p">],</span>
                     <span class="p">[</span><span class="s1">&#39;A2&#39;</span><span class="p">,</span> <span class="s1">&#39;B2&#39;</span><span class="p">,</span> <span class="s1">&#39;C2&#39;</span><span class="p">,</span> <span class="s1">&#39;D2&#39;</span><span class="p">,</span> <span class="s1">&#39;E2&#39;</span><span class="p">,</span> <span class="s1">&#39;F2&#39;</span><span class="p">,</span> <span class="s1">&#39;G2&#39;</span><span class="p">,</span> <span class="s1">&#39;H2&#39;</span><span class="p">],</span>
                     <span class="p">[</span><span class="s1">&#39;I2&#39;</span><span class="p">,</span> <span class="s1">&#39;J2&#39;</span><span class="p">,</span> <span class="s1">&#39;K2&#39;</span><span class="p">,</span> <span class="s1">&#39;L2&#39;</span><span class="p">,</span> <span class="s1">&#39;M2&#39;</span><span class="p">,</span> <span class="s1">&#39;N2&#39;</span><span class="p">,</span> <span class="s1">&#39;O2&#39;</span><span class="p">,</span> <span class="s1">&#39;P2&#39;</span><span class="p">],</span>
                     <span class="p">[</span><span class="s1">&#39;A3&#39;</span><span class="p">,</span> <span class="s1">&#39;B3&#39;</span><span class="p">,</span> <span class="s1">&#39;C3&#39;</span><span class="p">,</span> <span class="s1">&#39;D3&#39;</span><span class="p">,</span> <span class="s1">&#39;E3&#39;</span><span class="p">,</span> <span class="s1">&#39;F3&#39;</span><span class="p">,</span> <span class="s1">&#39;G3&#39;</span><span class="p">,</span> <span class="s1">&#39;H3&#39;</span><span class="p">],</span>
                     <span class="p">[</span><span class="s1">&#39;I3&#39;</span><span class="p">,</span> <span class="s1">&#39;J3&#39;</span><span class="p">,</span> <span class="s1">&#39;K3&#39;</span><span class="p">,</span> <span class="s1">&#39;L3&#39;</span><span class="p">,</span> <span class="s1">&#39;M3&#39;</span><span class="p">,</span> <span class="s1">&#39;N3&#39;</span><span class="p">,</span> <span class="s1">&#39;O3&#39;</span><span class="p">,</span> <span class="s1">&#39;P3&#39;</span><span class="p">],</span>
                     <span class="p">[</span><span class="s1">&#39;A4&#39;</span><span class="p">,</span> <span class="s1">&#39;B4&#39;</span><span class="p">,</span> <span class="s1">&#39;C4&#39;</span><span class="p">,</span> <span class="s1">&#39;D4&#39;</span><span class="p">,</span> <span class="s1">&#39;E4&#39;</span><span class="p">,</span> <span class="s1">&#39;F4&#39;</span><span class="p">,</span> <span class="s1">&#39;G4&#39;</span><span class="p">,</span> <span class="s1">&#39;H4&#39;</span><span class="p">],</span>
                     <span class="p">[</span><span class="s1">&#39;I4&#39;</span><span class="p">,</span> <span class="s1">&#39;J4&#39;</span><span class="p">,</span> <span class="s1">&#39;K4&#39;</span><span class="p">,</span> <span class="s1">&#39;L4&#39;</span><span class="p">,</span> <span class="s1">&#39;M4&#39;</span><span class="p">,</span> <span class="s1">&#39;N4&#39;</span><span class="p">,</span> <span class="s1">&#39;O4&#39;</span><span class="p">,</span> <span class="s1">&#39;P4&#39;</span><span class="p">]])</span>
<span class="p">}</span>

<span class="n">PIXEL_MASK</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">PIXEL_MAP</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;  &#39;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">PIXEL_MAP</span><span class="p">}</span>
<span class="n">_ROWS</span><span class="p">,</span> <span class="n">_COLS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>

<span class="n">PIXEL_MAP_INV</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">_ROWS</span><span class="p">[</span><span class="n">PIXEL_MAP</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;  &#39;</span><span class="p">],</span>
                                                  <span class="n">_COLS</span><span class="p">[</span><span class="n">PIXEL_MAP</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;  &#39;</span><span class="p">],</span>
                                                  <span class="n">PIXEL_MAP</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">PIXEL_MAP</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;  &#39;</span><span class="p">])}</span>
                 <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;6x6&#39;</span><span class="p">,</span> <span class="s1">&#39;4x4&#39;</span><span class="p">,</span> <span class="s1">&#39;8x8&#39;</span><span class="p">]}</span>


<span class="n">_msid_prefix</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;R&#39;</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">_aca_msid_list</span><span class="p">(</span><span class="n">pea</span><span class="p">):</span>
    <span class="c1"># helper method to make a dictionary with all global (non-slot) MSIDs used here</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;AOACSTAT&#39;</span><span class="p">,</span>  <span class="c1"># ASPECT CAMERA DATA PROCESSING OVERALL STATUS FLAG</span>
        <span class="s1">&#39;command_count&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_msid_prefix</span><span class="p">[</span><span class="n">pea</span><span class="p">]</span><span class="si">}</span><span class="s1">CCMDS&#39;</span><span class="p">,</span>
        <span class="s1">&#39;integration_time&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_msid_prefix</span><span class="p">[</span><span class="n">pea</span><span class="p">]</span><span class="si">}</span><span class="s1">ACAINT0&#39;</span><span class="p">,</span>
        <span class="s1">&#39;major_frame&#39;</span><span class="p">:</span> <span class="s1">&#39;CVCMJCTR&#39;</span><span class="p">,</span>
        <span class="s1">&#39;minor_frame&#39;</span><span class="p">:</span> <span class="s1">&#39;CVCMNCTR&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cmd_count&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_msid_prefix</span><span class="p">[</span><span class="n">pea</span><span class="p">]</span><span class="si">}</span><span class="s1">CCMDS&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cmd_progress&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_msid_prefix</span><span class="p">[</span><span class="n">pea</span><span class="p">]</span><span class="si">}</span><span class="s1">AROW2GO&#39;</span>  <span class="c1"># NUMBER OF ROWS TO GO COMMAND PROGRESS</span>

    <span class="p">}</span>


<span class="k">def</span> <span class="nf">_aca_image_msid_list</span><span class="p">(</span><span class="n">pea</span><span class="p">):</span>
    <span class="c1"># helper method to make a list of dictionaries with MSIDs for each slot in a given PEA.</span>
    <span class="n">msid_prefix</span> <span class="o">=</span> <span class="n">_msid_prefix</span><span class="p">[</span><span class="n">pea</span><span class="p">]</span>

    <span class="n">px_ids</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;J&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">}</span>
    <span class="n">px_nums</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)]</span>
    <span class="n">px_img_nums</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)]</span>

    <span class="n">pixels</span> <span class="o">=</span> <span class="p">[[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CIMG</span><span class="si">{</span><span class="n">px_img_num</span><span class="si">}{</span><span class="n">px_id</span><span class="si">}{</span><span class="n">px_num</span><span class="si">}</span><span class="s1">&#39;</span>
               <span class="k">for</span> <span class="n">px_num</span> <span class="ow">in</span> <span class="n">px_nums</span> <span class="k">for</span> <span class="n">px_id</span> <span class="ow">in</span> <span class="n">px_ids</span><span class="p">]</span>
              <span class="k">for</span> <span class="n">px_img_num</span> <span class="ow">in</span> <span class="n">px_img_nums</span><span class="p">]</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;pixels&#39;</span><span class="p">:</span> <span class="n">pixels</span><span class="p">,</span>
        <span class="s1">&#39;sizes&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA00040&#39;</span><span class="p">,</span>   <span class="c1"># Size of image 0</span>
                  <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA00043&#39;</span><span class="p">,</span>   <span class="c1"># Size of image 1</span>
                  <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA00046&#39;</span><span class="p">,</span>   <span class="c1"># Size of image 2</span>
                  <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA00049&#39;</span><span class="p">,</span>   <span class="c1"># Size of image 3</span>
                  <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA00052&#39;</span><span class="p">,</span>   <span class="c1"># Size of image 4</span>
                  <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA00055&#39;</span><span class="p">,</span>   <span class="c1"># Size of image 5</span>
                  <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA00058&#39;</span><span class="p">,</span>   <span class="c1"># Size of image 6</span>
                  <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA00061&#39;</span><span class="p">],</span>   <span class="c1"># Size of image 7</span>

        <span class="s1">&#39;rows&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA00076&#39;</span><span class="p">,</span>   <span class="c1"># Row of pixel A1 of image 0</span>
                 <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA00292&#39;</span><span class="p">,</span>   <span class="c1"># Row of pixel A1 of image 1</span>
                 <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA00508&#39;</span><span class="p">,</span>   <span class="c1"># Row of pixel A1 of image 2</span>
                 <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA00724&#39;</span><span class="p">,</span>   <span class="c1"># Row of pixel A1 of image 3</span>
                 <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA00940&#39;</span><span class="p">,</span>   <span class="c1"># Row of pixel A1 of image 4</span>
                 <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA01156&#39;</span><span class="p">,</span>   <span class="c1"># Row of pixel A1 of image 5</span>
                 <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA01372&#39;</span><span class="p">,</span>   <span class="c1"># Row of pixel A1 of image 6</span>
                 <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA01588&#39;</span><span class="p">],</span>   <span class="c1"># Row of pixel A1 of image 7</span>

        <span class="s1">&#39;cols&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA00086&#39;</span><span class="p">,</span>   <span class="c1"># Column of pixel A1 of image 0</span>
                 <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA00302&#39;</span><span class="p">,</span>   <span class="c1"># Column of pixel A1 of image 1</span>
                 <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA00518&#39;</span><span class="p">,</span>   <span class="c1"># Column of pixel A1 of image 2</span>
                 <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA00734&#39;</span><span class="p">,</span>   <span class="c1"># Column of pixel A1 of image 3</span>
                 <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA00950&#39;</span><span class="p">,</span>   <span class="c1"># Column of pixel A1 of image 4</span>
                 <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA01166&#39;</span><span class="p">,</span>   <span class="c1"># Column of pixel A1 of image 5</span>
                 <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA01382&#39;</span><span class="p">,</span>   <span class="c1"># Column of pixel A1 of image 6</span>
                 <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA01598&#39;</span><span class="p">],</span>  <span class="c1"># Column of pixel A1 of image 7</span>

        <span class="s1">&#39;scale_factor&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA00096&#39;</span><span class="p">,</span>   <span class="c1"># Scale factor of image 0</span>
                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA00312&#39;</span><span class="p">,</span>   <span class="c1"># Scale factor of image 1</span>
                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA00528&#39;</span><span class="p">,</span>   <span class="c1"># Scale factor of image 2</span>
                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA00744&#39;</span><span class="p">,</span>   <span class="c1"># Scale factor of image 3</span>
                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA00960&#39;</span><span class="p">,</span>   <span class="c1"># Scale factor of image 4</span>
                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA01176&#39;</span><span class="p">,</span>   <span class="c1"># Scale factor of image 5</span>
                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA01392&#39;</span><span class="p">,</span>   <span class="c1"># Scale factor of image 6</span>
                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA01608&#39;</span><span class="p">],</span>  <span class="c1"># Scale factor of image 7</span>

        <span class="s1">&#39;image_status&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;AOIMAGE</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)],</span>    <span class="c1"># IMAGE STATUS FLAG</span>
        <span class="s1">&#39;fiducial_flag&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;AOACFID</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)],</span>  <span class="c1"># FIDUCIAL LIGHT FLAG (OBC)</span>
        <span class="s1">&#39;image_function&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;AOACFCT</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)],</span>  <span class="c1"># IMAGE FUNCTION (OBC)</span>
        <span class="c1"># this one exists also as FUNCTION2/3/4</span>
        <span class="c1"># &#39;image_function_pea&#39;:</span>
        <span class="c1">#     [f&#39;{msid_prefix}AIMGF{i}1&#39; for i in range(8)],  # IMAGE FUNCTION1 (PEA)</span>

        <span class="s1">&#39;background_rms&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CRMSBG</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)],</span>
        <span class="s1">&#39;background_avg&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA00110&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA00326&#39;</span><span class="p">,</span>
                           <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA00542&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA00758&#39;</span><span class="p">,</span>
                           <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA00974&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA01190&#39;</span><span class="p">,</span>
                           <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA01406&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CA01622&#39;</span><span class="p">],</span>
        <span class="s1">&#39;housing_temperature&#39;</span><span class="p">:</span>
            <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">ACH1T</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">2&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)],</span>                 <span class="c1"># AC HOUSING TEMPERATURE</span>
        <span class="s1">&#39;ccd_temperature&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">CCDPT</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">2&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)],</span>  <span class="c1"># CCD TEMPERATURE</span>
        <span class="s1">&#39;primary_temperature&#39;</span><span class="p">:</span>
            <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">QTAPMT</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)],</span>  <span class="c1"># PRIMARY MIRROR/LENS CELL TEMP</span>
        <span class="s1">&#39;secondary_temperature&#39;</span><span class="p">:</span>
            <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s1">QTH2MT</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)],</span>  <span class="c1"># AC SECONDARY MIRROR TEMPERATURE</span>

        <span class="s1">&#39;magnitude&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;AOACMAG</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)],</span>       <span class="c1"># STAR OR FIDUCIAL MAGNITUDE (OBC)</span>
        <span class="s1">&#39;centroid_ang_y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;AOACYAN</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)],</span>  <span class="c1"># YAG CENTROID Y ANGLE (OBC)</span>
        <span class="s1">&#39;centroid_ang_z&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;AOACZAN</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)],</span>  <span class="c1"># ZAG CENTROID Z ANGLE (OBC)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">[{</span><span class="n">k</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)]</span>


<span class="n">ACA_MSID_LIST</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span> <span class="n">_aca_msid_list</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)}</span>
<span class="n">ACA_SLOT_MSID_LIST</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span> <span class="n">_aca_image_msid_list</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)}</span>


<span class="n">_a2p</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;J&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">]</span>
<span class="n">_IMG_INDICES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">PIXEL_MAP_INV</span><span class="p">[</span><span class="s1">&#39;4x4&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">1&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_a2p</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">PIXEL_MAP_INV</span><span class="p">[</span><span class="s1">&#39;6x6&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">1&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_a2p</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">PIXEL_MAP_INV</span><span class="p">[</span><span class="s1">&#39;6x6&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">2&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_a2p</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
    <span class="p">[],</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">PIXEL_MAP_INV</span><span class="p">[</span><span class="s1">&#39;8x8&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">1&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_a2p</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">PIXEL_MAP_INV</span><span class="p">[</span><span class="s1">&#39;8x8&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">2&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_a2p</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">PIXEL_MAP_INV</span><span class="p">[</span><span class="s1">&#39;8x8&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">3&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_a2p</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">PIXEL_MAP_INV</span><span class="p">[</span><span class="s1">&#39;8x8&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">4&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_a2p</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
<span class="p">]</span>

<span class="c1">######################</span>
<span class="c1"># VCDU-based functions</span>
<span class="c1">######################</span>

<span class="c1"># these are used multiple times</span>
<span class="n">_aca_front_fmt</span> <span class="o">=</span> <span class="n">Struct</span><span class="p">(</span><span class="s1">&#39;&gt;HBBBBBB&#39;</span><span class="p">)</span>
<span class="n">_size_bits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<span class="n">_pixel_bits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
<span class="n">_bits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">64</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


<span class="c1"># I&#39;m sure there is a better way...</span>
<span class="k">def</span> <span class="nf">_packbits</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">unsigned</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="c1"># take something like this: [1,0,1,1,0] and return 2^4 + 2^2 + 2</span>
    <span class="c1"># This handles integer types only</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">unsigned</span> <span class="ow">and</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">_bits</span><span class="p">[</span><span class="o">-</span><span class="n">n</span><span class="p">:])</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">n</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">_bits</span><span class="p">[</span><span class="o">-</span><span class="n">n</span><span class="p">:])</span>


<span class="k">class</span> <span class="nc">_AcaImageHeaderDecom</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to decommute ACA image telemtry headers.</span>

<span class="sd">    These methods are grouped into a class because header 3 packet is split into up to 8 parts.</span>
<span class="sd">    The __call__ method in this class accumulates the partial packets. Once all images are of known</span>
<span class="sd">    types, and the packets are known, it will return the header 3 data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_header</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_aca_header_1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aca_header_1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aca_header_2</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="p">{},</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_aca_header_1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aca_header_2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aca_header_3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aca_header_3</span><span class="p">,</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imgnum</span><span class="p">,</span> <span class="n">imgtype</span><span class="p">,</span> <span class="n">byte_array</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="n">imgtype</span><span class="p">](</span><span class="n">byte_array</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_aca_header_1</span><span class="p">(</span><span class="n">bits</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Unpack ACA header 1 (ACA User Manual 5.3.2.2.1).</span>

<span class="sd">        :param bits: bytes-like object of length 7</span>
<span class="sd">        :return: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unpackbits</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_unpack</span><span class="p">(</span><span class="s1">&#39;BBBbbBB&#39;</span><span class="p">,</span> <span class="n">bits</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;IMGFID&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="s1">&#39;IMGNUM&#39;</span><span class="p">:</span> <span class="n">_packbits</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]),</span>
            <span class="s1">&#39;IMGFUNC&#39;</span><span class="p">:</span> <span class="n">_packbits</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]),</span>
            <span class="s1">&#39;IMGSTAT&#39;</span><span class="p">:</span> <span class="n">_packbits</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">12</span><span class="p">]),</span>
            <span class="s1">&#39;SAT_PIXEL&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">6</span><span class="p">]),</span>
            <span class="s1">&#39;DEF_PIXEL&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">7</span><span class="p">]),</span>
            <span class="s1">&#39;QUAD_BOUND&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">8</span><span class="p">]),</span>
            <span class="s1">&#39;COMMON_COL&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">9</span><span class="p">]),</span>
            <span class="s1">&#39;MULTI_STAR&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">10</span><span class="p">]),</span>
            <span class="s1">&#39;ION_RAD&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">11</span><span class="p">]),</span>
            <span class="s1">&#39;IMGROW0&#39;</span><span class="p">:</span> <span class="n">_packbits</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">22</span><span class="p">],</span> <span class="n">unsigned</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="s1">&#39;IMGCOL0&#39;</span><span class="p">:</span> <span class="n">_packbits</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">22</span><span class="p">:</span><span class="mi">32</span><span class="p">],</span> <span class="n">unsigned</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="s1">&#39;IMGSCALE&#39;</span><span class="p">:</span> <span class="n">_packbits</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">32</span><span class="p">:</span><span class="mi">46</span><span class="p">]),</span>
            <span class="s1">&#39;BGDAVG&#39;</span><span class="p">:</span> <span class="n">_packbits</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">46</span><span class="p">:</span><span class="mi">56</span><span class="p">])</span>
        <span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_aca_header_2</span><span class="p">(</span><span class="n">bits</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Unpack ACA header 2 (ACA User Manual 5.3.2.2.2).</span>

<span class="sd">        :param bits: bytes-like object of length 7</span>
<span class="sd">        :return: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bits</span> <span class="o">=</span> <span class="n">_unpack</span><span class="p">(</span><span class="s1">&#39;BbbbbBB&#39;</span><span class="p">,</span> <span class="n">bits</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unpackbits</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bits</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="c1"># do we want these?</span>
            <span class="c1"># &#39;FID2&#39;: bool(bits[0]),</span>
            <span class="c1"># &#39;IMGNUM2&#39;: _packbits(bits[1:4]),</span>
            <span class="c1"># &#39;IMGFUNC2&#39;: _packbits(bits[4:6]),</span>
            <span class="s1">&#39;BGDRMS&#39;</span><span class="p">:</span> <span class="n">_packbits</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">16</span><span class="p">]),</span>
            <span class="s1">&#39;TEMPCCD&#39;</span><span class="p">:</span> <span class="n">bits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="s1">&#39;TEMPHOUS&#39;</span><span class="p">:</span> <span class="n">bits</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="s1">&#39;TEMPPRIM&#39;</span><span class="p">:</span> <span class="n">bits</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
            <span class="s1">&#39;TEMPSEC&#39;</span><span class="p">:</span> <span class="n">bits</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
            <span class="s1">&#39;BGDSTAT&#39;</span><span class="p">:</span> <span class="n">bits</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
            <span class="s1">&#39;BGDSTAT_PIXELS&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">unpackbits</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">:])</span>
        <span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_aca_header_3</span><span class="p">(</span><span class="n">bits</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Unpack ACA header 3 (ACA User Manual 5.3.2.2.3).</span>

<span class="sd">        :param bits: bytes-like object of length 7</span>
<span class="sd">        :return: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;DIAGNOSTIC&#39;</span><span class="p">:</span> <span class="n">_unpack</span><span class="p">(</span><span class="s1">&#39;BBBBBB&#39;</span><span class="p">,</span> <span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">:])}</span>


<div class="viewcode-block" id="unpack_aca_telemetry"><a class="viewcode-back" href="../../index.html#chandra_aca.maude_decom.unpack_aca_telemetry">[docs]</a><span class="k">def</span> <span class="nf">unpack_aca_telemetry</span><span class="p">(</span><span class="n">packet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Unpack ACA telemetry encoded in 225-byte packets.</span>

<span class="sd">    :param packet: bytes</span>
<span class="sd">    :return: list of dict</span>

<span class="sd">    A list of length 8, one entry per slot, where each entry is a dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">s3</span> <span class="o">=</span> <span class="n">_unpack</span><span class="p">(</span><span class="s1">&#39;BBB&#39;</span><span class="p">,</span> <span class="n">packet</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span>
    <span class="n">_size_bits</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unpackbits</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">s3</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
        <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">img_types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">packbits</span><span class="p">(</span><span class="n">_size_bits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">slots</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">header_decom</span> <span class="o">=</span> <span class="n">_AcaImageHeaderDecom</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">img_num</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">packet</span><span class="p">),</span> <span class="mi">27</span><span class="p">)):</span>
        <span class="n">img_header</span> <span class="o">=</span> <span class="n">header_decom</span><span class="p">(</span><span class="n">img_num</span><span class="p">,</span> <span class="n">img_types</span><span class="p">[</span><span class="n">img_num</span><span class="p">],</span> <span class="n">packet</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">7</span><span class="p">])</span>
        <span class="n">img_pixels</span> <span class="o">=</span> <span class="n">_unpack</span><span class="p">(</span><span class="s1">&#39;B&#39;</span> <span class="o">*</span> <span class="mi">20</span><span class="p">,</span> <span class="n">packet</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">7</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">27</span><span class="p">])</span>
        <span class="n">_pixel_bits</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">10</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unpackbits</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">img_pixels</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                             <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">img_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">packbits</span><span class="p">(</span><span class="n">_pixel_bits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">[[</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">img_header</span><span class="p">[</span><span class="s1">&#39;pixels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_pixels</span>
        <span class="n">slots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img_header</span><span class="p">)</span>

    <span class="c1"># Before the dynamic background patch, the first two bytes contained INTEG in those</span>
    <span class="c1"># 16 bits (named integbits).  After the dynamic background patch, the first 6 bits of</span>
    <span class="c1"># integbits will be repurposed: two bits for PIXTLM, next bit for BGDTYP, 3 spares,</span>
    <span class="c1"># and 10 bits for INTEG.  This telem/decom change is back-compatible and can be promoted</span>
    <span class="c1"># before the dynamic background patch is in use onboard.</span>
    <span class="n">integbits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unpackbits</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_unpack</span><span class="p">(</span><span class="s1">&#39;BB&#39;</span><span class="p">,</span> <span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
    <span class="n">pixtlm</span> <span class="o">=</span> <span class="n">_packbits</span><span class="p">(</span><span class="n">integbits</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">bgdtyp</span> <span class="o">=</span> <span class="n">integbits</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">integ</span> <span class="o">=</span> <span class="n">_packbits</span><span class="p">(</span><span class="n">integbits</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span>
    <span class="n">glbstat</span> <span class="o">=</span> <span class="n">_unpack</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">bits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unpackbits</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_unpack</span><span class="p">(</span><span class="s1">&#39;BBB&#39;</span><span class="p">,</span> <span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;PIXTLM&#39;</span><span class="p">:</span> <span class="n">pixtlm</span><span class="p">,</span>
        <span class="s1">&#39;BGDTYP&#39;</span><span class="p">:</span> <span class="n">bgdtyp</span><span class="p">,</span>
        <span class="s1">&#39;INTEG&#39;</span><span class="p">:</span> <span class="n">integ</span><span class="p">,</span>
        <span class="s1">&#39;GLBSTAT&#39;</span><span class="p">:</span> <span class="n">glbstat</span><span class="p">,</span>
        <span class="s1">&#39;HIGH_BGD&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="s1">&#39;RAM_FAIL&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="s1">&#39;ROM_FAIL&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
        <span class="s1">&#39;POWER_FAIL&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
        <span class="s1">&#39;CAL_FAIL&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span>
        <span class="s1">&#39;COMM_CHECKSUM_FAIL&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span>
        <span class="s1">&#39;RESET&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">6</span><span class="p">]),</span>
        <span class="s1">&#39;SYNTAX_ERROR&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">7</span><span class="p">]),</span>
        <span class="s1">&#39;COMMCNT&#39;</span><span class="p">:</span> <span class="n">_packbits</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">14</span><span class="p">],</span> <span class="n">unsigned</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="s1">&#39;COMMCNT_SYNTAX_ERROR&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">14</span><span class="p">]),</span>
        <span class="s1">&#39;COMMCNT_CHECKSUM_FAIL&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">15</span><span class="p">]),</span>
        <span class="s1">&#39;COMMPROG&#39;</span><span class="p">:</span> <span class="n">_packbits</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="mi">22</span><span class="p">],</span> <span class="n">unsigned</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="s1">&#39;COMMPROG_REPEAT&#39;</span><span class="p">:</span> <span class="n">_packbits</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">22</span><span class="p">:</span><span class="mi">24</span><span class="p">],</span> <span class="n">unsigned</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">slots</span><span class="p">):</span>
        <span class="n">s</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="n">s</span><span class="p">[</span><span class="s1">&#39;IMGTYPE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">slots</span></div>


<span class="k">def</span> <span class="nf">_combine_aca_packets</span><span class="p">(</span><span class="n">aca_packets</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combine a list of ACA packets into a single record.</span>

<span class="sd">    This is intended to combine the two 6X6 packets or the four 8X8 packets.</span>

<span class="sd">    :param aca_packets: list of dict</span>
<span class="sd">    :return: dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># note that they are reverse-sorted so the first frame overwrites the others if they collide</span>
    <span class="n">aca_packets</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">aca_packets</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;TIME&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_all</span><span class="p">((</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">pixels</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">aca_packets</span><span class="p">:</span>
        <span class="n">pixels</span><span class="p">[</span><span class="n">_IMG_INDICES</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;IMGTYPE&#39;</span><span class="p">]][</span><span class="mi">0</span><span class="p">],</span> <span class="n">_IMG_INDICES</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;IMGTYPE&#39;</span><span class="p">]][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;pixels&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">aca_packets</span><span class="p">:</span>
        <span class="n">res</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;pixels&#39;</span><span class="p">]</span>
    <span class="n">res</span><span class="p">[</span><span class="s1">&#39;IMG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pixels</span>
    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">_group_packets</span><span class="p">(</span><span class="n">packets</span><span class="p">,</span> <span class="n">discard</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ACA telemetry is packed in packets of 225 bytes. Each of these is split in four VCDU frames.</span>
<span class="sd">    Before decommuting an ACA package we group the ACA-related portion of VCDU frames to form the</span>
<span class="sd">    one 225-byte ACA packet.</span>

<span class="sd">    :param packets: list of ACA sub-packets</span>
<span class="sd">    :param discard: bool to discard incomplete ACA packets</span>
<span class="sd">    :return: list of ACA packets</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">s</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">packet</span> <span class="ow">in</span> <span class="n">packets</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">and</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="s1">&#39;MJF&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">128</span> <span class="o">+</span> <span class="n">packet</span><span class="p">[</span><span class="s1">&#39;MNF&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">discard</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="n">s</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">res</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">:</span>
            <span class="c1"># the number of minor frames expected within the same ACA packet</span>
            <span class="n">s</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">:</span> <span class="mi">4</span><span class="p">}[</span><span class="n">packet</span><span class="p">[</span><span class="s1">&#39;IMGTYPE&#39;</span><span class="p">]]</span>
            <span class="c1"># the number of minor frames within the same ACA packet expected after this minor frame</span>
            <span class="n">remaining</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">:</span> <span class="mi">0</span><span class="p">}[</span><span class="n">packet</span><span class="p">[</span><span class="s1">&#39;IMGTYPE&#39;</span><span class="p">]]</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="s1">&#39;MJF&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">128</span> <span class="o">+</span> <span class="n">packet</span><span class="p">[</span><span class="s1">&#39;MNF&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">remaining</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">discard</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">res</span>


<div class="viewcode-block" id="get_raw_aca_packets"><a class="viewcode-back" href="../../index.html#chandra_aca.maude_decom.get_raw_aca_packets">[docs]</a><span class="k">def</span> <span class="nf">get_raw_aca_packets</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="o">**</span><span class="n">maude_kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetch 1025-byte VCDU frames using MAUDE and extract a list of 225-byte ACA packets.</span>

<span class="sd">    If the first minor frame in a group of four ACA packets is within (start, stop),</span>
<span class="sd">    the three following minor frames are included if present.</span>

<span class="sd">    returns a dictionary with keys [&#39;TIME&#39;, &#39;MNF&#39;, &#39;MJF&#39;, &#39;packets&#39;, &#39;flags&#39;].</span>
<span class="sd">    These correspond to the minor frame time, minor frame count, major frame count,</span>
<span class="sd">    the list of packets, and flags returned by MAUDE respectively.</span>

<span class="sd">    :param start: timestamp interpreted as a Chandra.Time.DateTime</span>
<span class="sd">    :param stop: timestamp interpreted as a Chandra.Time.DateTime</span>
<span class="sd">    :param ``**maude_kwargs``: keyword args passed to maude.get_frames()</span>
<span class="sd">    :return: dict</span>

<span class="sd">        {&#39;flags&#39;: int, &#39;packets&#39;: [],</span>
<span class="sd">         &#39;TIME&#39;: np.array([]), &#39;MNF&#39;: np.array([]), &#39;MJF&#39;: np.array([])}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">date_start</span><span class="p">,</span> <span class="n">date_stop</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span>  <span class="c1"># ensure input is proper date</span>
    <span class="n">stop_pad</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">/</span> <span class="mi">86400</span>  <span class="c1"># padding at the end in case of trailing partial ACA packets</span>

    <span class="c1"># also getting major and minor frames to figure out which is the first ACA packet in a group</span>
    <span class="n">vcdu_counter</span> <span class="o">=</span> <span class="n">maude</span><span class="o">.</span><span class="n">get_msids</span><span class="p">([</span><span class="s1">&#39;CVCMNCTR&#39;</span><span class="p">,</span> <span class="s1">&#39;CVCMJCTR&#39;</span><span class="p">,</span> <span class="s1">&#39;CVCDUCTR&#39;</span><span class="p">],</span>
                                   <span class="n">start</span><span class="o">=</span><span class="n">date_start</span><span class="p">,</span>
                                   <span class="n">stop</span><span class="o">=</span><span class="n">date_stop</span> <span class="o">+</span> <span class="n">stop_pad</span><span class="p">,</span> <span class="o">**</span><span class="n">maude_kwargs</span><span class="p">)</span>

    <span class="n">sub</span> <span class="o">=</span> <span class="n">vcdu_counter</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="mi">4</span>  <span class="c1"># the minor frame index within each ACA update</span>
    <span class="n">vcdu_times</span> <span class="o">=</span> <span class="n">vcdu_counter</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;times&#39;</span><span class="p">]</span>

    <span class="n">major_counter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">sub</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># this number is monotonically increasing starting at 0</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">major_counter</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">major_counter</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="c1"># only unpack complete ACA frames in the original range:</span>
    <span class="n">aca_frame_entries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_all</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">aca_frame_entries</span><span class="p">[</span><span class="n">major_counter</span><span class="p">,</span> <span class="n">sub</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">vcdu_times</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">aca_frame_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_all</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">aca_frame_times</span><span class="p">[</span><span class="n">major_counter</span><span class="p">,</span> <span class="n">sub</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcdu_times</span>

    <span class="c1"># this will remove ACA records with at least one missing minor frame</span>
    <span class="n">select</span> <span class="o">=</span> <span class="p">((</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">aca_frame_times</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span>
              <span class="p">(</span><span class="n">aca_frame_times</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">date_start</span><span class="o">.</span><span class="n">secs</span><span class="p">)</span> <span class="o">*</span>
              <span class="p">(</span><span class="n">aca_frame_times</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">date_stop</span><span class="o">.</span><span class="n">secs</span><span class="p">))</span>

    <span class="c1"># get the frames and unpack front matter</span>
    <span class="n">frames</span> <span class="o">=</span> <span class="n">maude</span><span class="o">.</span><span class="n">get_frames</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">date_start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">date_stop</span> <span class="o">+</span> <span class="n">stop_pad</span><span class="p">,</span> <span class="o">**</span><span class="n">maude_kwargs</span><span class="p">)[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="n">frames</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">]</span>
    <span class="n">frames</span> <span class="o">=</span> <span class="n">frames</span><span class="p">[</span><span class="s1">&#39;frames&#39;</span><span class="p">]</span>

    <span class="c1"># assemble the 56 bit ACA minor records and times (time is not unpacked)</span>
    <span class="n">aca</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">aca_times</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">:</span>
        <span class="n">aca_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">])</span>
        <span class="n">aca</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">frame</span><span class="p">[</span><span class="s1">&#39;bytes&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">:</span><span class="n">j</span> <span class="o">+</span> <span class="mi">14</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">18</span><span class="p">,</span> <span class="mi">274</span><span class="p">,</span> <span class="mi">530</span><span class="p">,</span> <span class="mi">780</span><span class="p">]]))</span>

    <span class="c1"># combine them into 224 byte frames (it currently ensures all 224 bytes are there)</span>
    <span class="n">aca_packets</span> <span class="o">=</span> <span class="p">[</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">aca</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">])</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">aca_frame_entries</span><span class="p">[</span><span class="n">select</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">aca_packets</span><span class="p">:</span>
        <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">224</span><span class="p">)</span>

    <span class="n">times</span> <span class="o">=</span> <span class="n">vcdu_counter</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;times&#39;</span><span class="p">][</span><span class="n">aca_frame_entries</span><span class="p">[</span><span class="n">select</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
    <span class="n">minor_counter</span> <span class="o">=</span> <span class="n">vcdu_counter</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">][</span><span class="n">aca_frame_entries</span><span class="p">[</span><span class="n">select</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
    <span class="n">major_counter</span> <span class="o">=</span> <span class="n">vcdu_counter</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">][</span><span class="n">aca_frame_entries</span><span class="p">[</span><span class="n">select</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
    <span class="n">vcdu_counter</span> <span class="o">=</span> <span class="n">vcdu_counter</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">][</span><span class="n">aca_frame_entries</span><span class="p">[</span><span class="n">select</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;flags&#39;</span><span class="p">:</span> <span class="n">flags</span><span class="p">,</span> <span class="s1">&#39;packets&#39;</span><span class="p">:</span> <span class="n">aca_packets</span><span class="p">,</span>
            <span class="s1">&#39;TIME&#39;</span><span class="p">:</span> <span class="n">times</span><span class="p">,</span> <span class="s1">&#39;MNF&#39;</span><span class="p">:</span> <span class="n">minor_counter</span><span class="p">,</span> <span class="s1">&#39;MJF&#39;</span><span class="p">:</span> <span class="n">major_counter</span><span class="p">,</span> <span class="s1">&#39;VCDUCTR&#39;</span><span class="p">:</span> <span class="n">vcdu_counter</span>
            <span class="p">}</span></div>


<span class="k">def</span> <span class="nf">_aca_packets_to_table</span><span class="p">(</span><span class="n">aca_packets</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Store ACA packets in a table.</span>

<span class="sd">    :param aca_packets: list of dict</span>
<span class="sd">    :return: astropy.table.Table</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">copy</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span>
        <span class="p">[(</span><span class="s1">&#39;TIME&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;VCDUCTR&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;MJF&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;MNF&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;IMGNUM&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;COMMCNT&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;COMMPROG&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;GLBSTAT&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;IMGFUNC&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;IMGTYPE&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;IMGSCALE&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;IMGROW0&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;IMGCOL0&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;INTEG&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;BGDAVG&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;BGDRMS&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;TEMPCCD&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;TEMPHOUS&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;TEMPPRIM&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;TEMPSEC&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;BGDSTAT&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;HIGH_BGD&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;RAM_FAIL&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;ROM_FAIL&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;POWER_FAIL&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;CAL_FAIL&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;COMM_CHECKSUM_FAIL&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;RESET&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;SYNTAX_ERROR&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;COMMCNT_SYNTAX_ERROR&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;COMMCNT_CHECKSUM_FAIL&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;COMMPROG_REPEAT&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;IMGFID&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;IMGSTAT&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;SAT_PIXEL&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;DEF_PIXEL&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;QUAD_BOUND&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;COMMON_COL&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;MULTI_STAR&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;ION_RAD&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;IMGROW_A1&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;IMGCOL_A1&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;IMGROW0_8X8&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;IMGCOL0_8X8&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;END_INTEG_TIME&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;PIXTLM&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;BGDTYP&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>
         <span class="p">])</span>

    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_all</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aca_packets</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">names</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">aca_packet</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">aca_packets</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;IMG&#39;</span> <span class="ow">in</span> <span class="n">aca_packet</span><span class="p">:</span>
            <span class="n">img</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aca_packet</span><span class="p">[</span><span class="s1">&#39;IMG&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">aca_packet</span><span class="p">:</span>
                <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">aca_packet</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

    <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">img</span><span class="p">:</span>
        <span class="n">table</span><span class="p">[</span><span class="s1">&#39;IMG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">aca_packet</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">aca_packets</span><span class="p">):</span>
            <span class="n">table</span><span class="p">[</span><span class="s1">&#39;IMG&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">aca_packet</span><span class="p">[</span><span class="s1">&#39;IMG&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span>
    <span class="k">return</span> <span class="n">table</span>


<div class="viewcode-block" id="get_aca_packets"><a class="viewcode-back" href="../../index.html#chandra_aca.maude_decom.get_aca_packets">[docs]</a><span class="k">def</span> <span class="nf">get_aca_packets</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">level0</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">combine</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">adjust_time</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">calibrate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">maude_kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetch VCDU 1025-byte frames, extract ACA packets, unpack them and store them in a table.</span>

<span class="sd">    Incomplete ACA packets (if there is a minor frame missing) can be combined or not into records</span>
<span class="sd">    with complete ACA telemetry. Compare these to calls to the function:</span>

<span class="sd">            &gt;&gt;&gt; from chandra_aca import maude_decom</span>
<span class="sd">            &gt;&gt;&gt; img = maude_decom.get_aca_packets(684089000, 684089016, combine=True)</span>
<span class="sd">            &gt;&gt;&gt; img = img[img[&#39;IMGNUM&#39;] == 0]</span>
<span class="sd">            &gt;&gt;&gt; img[&#39;TIME&#39;, &#39;MJF&#39;, &#39;MNF&#39;, &#39;COMMCNT&#39;, &#39;GLBSTAT&#39;, &#39;IMGTYPE&#39;, &#39;IMGROW0&#39;, &#39;IMGCOL0&#39;,</span>
<span class="sd">            &gt;&gt;&gt;     &#39;TEMPCCD&#39;, &#39;TEMPHOUS&#39;]</span>
<span class="sd">            &lt;Table masked=True length=4&gt;</span>
<span class="sd">                 TIME      MJF    MNF   COMMCNT GLBSTAT IMGTYPE IMGROW0 IMGCOL0 TEMPCCD TEMPHOUS</span>
<span class="sd">               float64    uint32 uint32  uint8   uint8   uint8   int16   int16   int16   int16</span>
<span class="sd">            ------------- ------ ------ ------- ------- ------- ------- ------- ------- --------</span>
<span class="sd">            684089001.869  78006     32       0       0       4     469    -332     -20       83</span>
<span class="sd">            684089005.969  78006     48       0       0       4     469    -332     -20       83</span>
<span class="sd">            684089010.069  78006     64       0       0       4     469    -332     -20       83</span>
<span class="sd">            684089014.169  78006     80       0       0       4     469    -332     -20       83</span>

<span class="sd">    Using combined=False, results in records with incomplete images. In this case, data can be</span>
<span class="sd">    missing from some records. For example, with 8X8 images, IMGROW0 and IMGCOL0 are present in the</span>
<span class="sd">    first ACA packet (image type 4) while the temperature is present in the second (image type 5):</span>

<span class="sd">        &gt;&gt;&gt; from chandra_aca import maude_decom</span>
<span class="sd">        &gt;&gt;&gt; img = maude_decom.get_aca_packets(684089000, 684089016, combine=False)</span>
<span class="sd">        &gt;&gt;&gt; img = img[img[&#39;IMGNUM&#39;] == 0]</span>
<span class="sd">        &gt;&gt;&gt; img[&#39;TIME&#39;, &#39;MJF&#39;, &#39;MNF&#39;, &#39;COMMCNT&#39;, &#39;GLBSTAT&#39;, &#39;IMGTYPE&#39;, &#39;IMGROW0&#39;, &#39;IMGCOL0&#39;,</span>
<span class="sd">        &gt;&gt;&gt;     &#39;TEMPCCD&#39;, &#39;TEMPHOUS&#39;]</span>
<span class="sd">            &lt;Table masked=True length=15&gt;</span>
<span class="sd">                 TIME      MJF    MNF   COMMCNT GLBSTAT IMGTYPE IMGROW0 IMGCOL0 TEMPCCD TEMPHOUS</span>
<span class="sd">               float64    uint32 uint32  uint8   uint8   uint8   int16   int16   int16   int16</span>
<span class="sd">            ------------- ------ ------ ------- ------- ------- ------- ------- ------- --------</span>
<span class="sd">            684089000.844  78006     28       0       0       7      --      --      --       --</span>
<span class="sd">            684089001.869  78006     32       0       0       4     469    -332      --       --</span>
<span class="sd">            684089002.894  78006     36       0       0       5      --      --     -20       83</span>
<span class="sd">            684089003.919  78006     40       0       0       6      --      --      --       --</span>
<span class="sd">            684089004.944  78006     44       0       0       7      --      --      --       --</span>
<span class="sd">            684089005.969  78006     48       0       0       4     469    -332      --       --</span>
<span class="sd">            684089006.994  78006     52       0       0       5      --      --     -20       83</span>
<span class="sd">            684089008.019  78006     56       0       0       6      --      --      --       --</span>
<span class="sd">            684089009.044  78006     60       0       0       7      --      --      --       --</span>
<span class="sd">            684089010.069  78006     64       0       0       4     469    -332      --       --</span>
<span class="sd">            684089011.094  78006     68       0       0       5      --      --     -20       83</span>
<span class="sd">            684089012.119  78006     72       0       0       6      --      --      --       --</span>
<span class="sd">            684089013.144  78006     76       0       0       7      --      --      --       --</span>
<span class="sd">            684089014.169  78006     80       0       0       4     469    -332      --       --</span>
<span class="sd">            684089015.194  78006     84       0       0       5      --      --     -20       83</span>

<span class="sd">        &gt;&gt;&gt; img[&#39;IMG&#39;].data[1]</span>
<span class="sd">        masked_BaseColumn(data =</span>
<span class="sd">         [[60.0 97.0 70.0 120.0 74.0 111.0 103.0 108.0]</span>
<span class="sd">         [67.0 90.0 144.0 96.0 88.0 306.0 82.0 67.0]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]],</span>
<span class="sd">                          mask =</span>
<span class="sd">         [[False False False False False False False False]</span>
<span class="sd">         [False False False False False False False False]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]],</span>
<span class="sd">                    fill_value = 1e+20)</span>

<span class="sd">        &gt;&gt;&gt; img[&#39;IMG&#39;].data[2]</span>
<span class="sd">        masked_BaseColumn(data =</span>
<span class="sd">         [[-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [76.0 81.0 160.0 486.0 449.0 215.0 88.0 156.0]</span>
<span class="sd">         [68.0 91.0 539.0 483.0 619.0 412.0 105.0 77.0]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]],</span>
<span class="sd">                          mask =</span>
<span class="sd">         [[ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [False False False False False False False False]</span>
<span class="sd">         [False False False False False False False False]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]],</span>
<span class="sd">                    fill_value = 1e+20)</span>

<span class="sd">        &gt;&gt;&gt; img[&#39;IMG&#39;].data[3]</span>
<span class="sd">        masked_BaseColumn(data =</span>
<span class="sd">         [[-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [86.0 101.0 408.0 344.0 556.0 343.0 122.0 67.0]</span>
<span class="sd">         [196.0 195.0 114.0 321.0 386.0 115.0 69.0 189.0]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]],</span>
<span class="sd">                          mask =</span>
<span class="sd">         [[ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [False False False False False False False False]</span>
<span class="sd">         [False False False False False False False False]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]],</span>
<span class="sd">                    fill_value = 1e+20)</span>

<span class="sd">        &gt;&gt;&gt; img[&#39;IMG&#39;].data[4]</span>
<span class="sd">        Out[10]:</span>
<span class="sd">        masked_BaseColumn(data =</span>
<span class="sd">         [[-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [67.0 61.0 67.0 176.0 99.0 72.0 79.0 88.0]</span>
<span class="sd">         [70.0 62.0 101.0 149.0 163.0 89.0 60.0 76.0]],</span>
<span class="sd">                          mask =</span>
<span class="sd">         [[ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [False False False False False False False False]</span>
<span class="sd">         [False False False False False False False False]],</span>
<span class="sd">                    fill_value = 1e+20)</span>


<span class="sd">    :param start: timestamp interpreted as a Chandra.Time.DateTime</span>
<span class="sd">    :param stop: timestamp interpreted as a Chandra.Time.DateTime</span>
<span class="sd">    :param level0: bool.</span>
<span class="sd">        Implies combine=True, adjust_time=True, calibrate=True</span>
<span class="sd">    :param combine: bool.</span>
<span class="sd">        If True, multiple ACA packets are combined to form an image (depending on size),</span>
<span class="sd">        If False, ACA packets are not combined, resulting in multiple lines for 6x6 and 8x8 images.</span>
<span class="sd">    :param adjust_time: bool</span>
<span class="sd">        If True, half the integration time is subtracted</span>
<span class="sd">    :param calibrate: bool</span>
<span class="sd">        If True, pixel values will be &#39;value * imgscale / 32 - 50&#39; and temperature values will</span>
<span class="sd">        be: 0.4 * value + 273.15</span>
<span class="sd">    :param ``**maude_kwargs``: keyword args passed to maude</span>
<span class="sd">    :return: astropy.table.Table</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">level0</span><span class="p">:</span>
        <span class="n">adjust_time</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">combine</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">calibrate</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span>  <span class="c1"># ensure input is proper date</span>
    <span class="k">if</span> <span class="mi">24</span> <span class="o">*</span> <span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Requested </span><span class="si">{</span><span class="mi">24</span> <span class="o">*</span> <span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span><span class="si">}</span><span class="s1"> hours of telemetry. &#39;</span>
                         <span class="s1">&#39;Maximum allowed is 3 hours at a time&#39;</span><span class="p">)</span>

    <span class="n">stop_pad</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">adjust_time</span><span class="p">:</span>
        <span class="n">stop_pad</span> <span class="o">+=</span> <span class="mf">2.</span> <span class="o">/</span> <span class="mi">86400</span>  <span class="c1"># time will get shifted...</span>
    <span class="k">if</span> <span class="n">combine</span><span class="p">:</span>
        <span class="n">stop_pad</span> <span class="o">+=</span> <span class="mf">3.08</span> <span class="o">/</span> <span class="mi">86400</span>  <span class="c1"># there can be trailing frames</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mi">86400</span> <span class="o">*</span> <span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="mi">300</span><span class="p">))</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span>
    <span class="n">batches</span> <span class="o">=</span> <span class="p">[(</span><span class="n">start</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">dt</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>  <span class="c1"># 0.0001????</span>
    <span class="n">aca_packets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="ow">in</span> <span class="n">batches</span><span class="p">:</span>
        <span class="n">raw_aca_packets</span> <span class="o">=</span> <span class="n">get_raw_aca_packets</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">+</span> <span class="n">stop_pad</span><span class="p">,</span> <span class="o">**</span><span class="n">maude_kwargs</span><span class="p">)</span>
        <span class="n">packets</span> <span class="o">=</span> <span class="n">_get_aca_packets</span><span class="p">(</span>
            <span class="n">raw_aca_packets</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span>
            <span class="n">combine</span><span class="o">=</span><span class="n">combine</span><span class="p">,</span> <span class="n">adjust_time</span><span class="o">=</span><span class="n">adjust_time</span><span class="p">,</span> <span class="n">calibrate</span><span class="o">=</span><span class="n">calibrate</span>
        <span class="p">)</span>
        <span class="n">aca_packets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">packets</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">vstack</span><span class="p">(</span><span class="n">aca_packets</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_get_aca_packets</span><span class="p">(</span><span class="n">aca_packets</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span>
                     <span class="n">combine</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">adjust_time</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">calibrate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a convenience function that splits get_aca_packets for testing without MAUDE.</span>
<span class="sd">    Same arguments as get_aca_packets plus aca_packets, the raw ACA 225-byte packets.</span>

<span class="sd">    NOTE: This function has a side effect. It adds decom_packets to the input aca_packets.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span>  <span class="c1"># ensure input is proper date</span>

    <span class="n">aca_packets</span><span class="p">[</span><span class="s1">&#39;decom_packets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">unpack_aca_telemetry</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">aca_packets</span><span class="p">[</span><span class="s1">&#39;packets&#39;</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aca_packets</span><span class="p">[</span><span class="s1">&#39;decom_packets&#39;</span><span class="p">])):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
            <span class="n">aca_packets</span><span class="p">[</span><span class="s1">&#39;decom_packets&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;TIME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aca_packets</span><span class="p">[</span><span class="s1">&#39;TIME&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">aca_packets</span><span class="p">[</span><span class="s1">&#39;decom_packets&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;MJF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aca_packets</span><span class="p">[</span><span class="s1">&#39;MJF&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">aca_packets</span><span class="p">[</span><span class="s1">&#39;decom_packets&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;MNF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aca_packets</span><span class="p">[</span><span class="s1">&#39;MNF&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;VCDUCTR&#39;</span> <span class="ow">in</span> <span class="n">aca_packets</span><span class="p">:</span>
                <span class="n">aca_packets</span><span class="p">[</span><span class="s1">&#39;decom_packets&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;VCDUCTR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aca_packets</span><span class="p">[</span><span class="s1">&#39;VCDUCTR&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">aca_packets</span><span class="p">[</span><span class="s1">&#39;decom_packets&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;IMGNUM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>

    <span class="n">aca_packets</span> <span class="o">=</span> <span class="p">[[</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">aca_packets</span><span class="p">[</span><span class="s1">&#39;decom_packets&#39;</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">combine</span><span class="p">:</span>
        <span class="n">aca_packets</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([[</span><span class="n">_combine_aca_packets</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">_group_packets</span><span class="p">(</span><span class="n">p</span><span class="p">)]</span>
                           <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">aca_packets</span><span class="p">],</span> <span class="p">[])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">aca_packets</span> <span class="o">=</span> <span class="p">[</span><span class="n">_combine_aca_packets</span><span class="p">([</span><span class="n">row</span><span class="p">])</span> <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">aca_packets</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">slot</span><span class="p">]</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">_aca_packets_to_table</span><span class="p">(</span><span class="n">aca_packets</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">calibrate</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;TEMPCCD&#39;</span><span class="p">,</span> <span class="s1">&#39;TEMPSEC&#39;</span><span class="p">,</span> <span class="s1">&#39;TEMPHOUS&#39;</span><span class="p">,</span> <span class="s1">&#39;TEMPPRIM&#39;</span><span class="p">]:</span>
            <span class="n">table</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="n">table</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">+</span> <span class="mf">273.15</span>

    <span class="c1"># IMGROW0/COL0 are actually the row/col of pixel A1, so we just copy them</span>
    <span class="n">table</span><span class="p">[</span><span class="s1">&#39;IMGROW_A1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s1">&#39;IMGROW0&#39;</span><span class="p">]</span>
    <span class="n">table</span><span class="p">[</span><span class="s1">&#39;IMGCOL_A1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s1">&#39;IMGCOL0&#39;</span><span class="p">]</span>

    <span class="c1"># if the image is embedded in an 8x8 image, row/col of the 8x8 shifts for sizes 4x4 and 6x6</span>
    <span class="n">table</span><span class="p">[</span><span class="s1">&#39;IMGROW0_8X8&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s1">&#39;IMGROW_A1&#39;</span><span class="p">]</span>
    <span class="n">table</span><span class="p">[</span><span class="s1">&#39;IMGCOL0_8X8&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s1">&#39;IMGCOL_A1&#39;</span><span class="p">]</span>
    <span class="n">table</span><span class="p">[</span><span class="s1">&#39;IMGROW0_8X8&#39;</span><span class="p">][</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;IMGTYPE&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">2</span>
    <span class="n">table</span><span class="p">[</span><span class="s1">&#39;IMGCOL0_8X8&#39;</span><span class="p">][</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;IMGTYPE&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">2</span>

    <span class="c1"># and the usual row/col needs to be adjusted only for 6x6 images</span>
    <span class="n">table</span><span class="p">[</span><span class="s1">&#39;IMGROW0&#39;</span><span class="p">][</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;IMGTYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="n">table</span><span class="p">[</span><span class="s1">&#39;IMGCOL0&#39;</span><span class="p">][</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;IMGTYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="n">table</span><span class="p">[</span><span class="s1">&#39;IMGROW0&#39;</span><span class="p">][</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;IMGTYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="n">table</span><span class="p">[</span><span class="s1">&#39;IMGCOL0&#39;</span><span class="p">][</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;IMGTYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">adjust_time</span><span class="p">:</span>
        <span class="n">table</span><span class="p">[</span><span class="s1">&#39;INTEG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s1">&#39;INTEG&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.016</span>
        <span class="n">table</span><span class="p">[</span><span class="s1">&#39;TIME&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="n">table</span><span class="p">[</span><span class="s1">&#39;INTEG&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">1.025</span>
        <span class="n">table</span><span class="p">[</span><span class="s1">&#39;END_INTEG_TIME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s1">&#39;TIME&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">table</span><span class="p">[</span><span class="s1">&#39;INTEG&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="k">if</span> <span class="n">calibrate</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;IMG&#39;</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
            <span class="n">table</span><span class="p">[</span><span class="s1">&#39;IMG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s1">&#39;IMG&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">table</span><span class="p">[</span><span class="s1">&#39;IMGSCALE&#39;</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">/</span> <span class="mi">32</span> <span class="o">-</span> <span class="mi">50</span>

    <span class="n">table</span> <span class="o">=</span> <span class="n">table</span><span class="p">[(</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;TIME&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="o">.</span><span class="n">secs</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;TIME&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">stop</span><span class="o">.</span><span class="n">secs</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">table</span>


<div class="viewcode-block" id="get_aca_images"><a class="viewcode-back" href="../../index.html#chandra_aca.maude_decom.get_aca_images">[docs]</a><span class="k">def</span> <span class="nf">get_aca_images</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="o">**</span><span class="n">maude_kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetch ACA image telemetry</span>

<span class="sd">    :param start: timestamp interpreted as a Chandra.Time.DateTime</span>
<span class="sd">    :param stop: timestamp interpreted as a Chandra.Time.DateTime</span>
<span class="sd">    :param ``**maude_kwargs``: keyword args passed to maude</span>
<span class="sd">    :return: astropy.table.Table</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">get_aca_packets</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">level0</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">maude_kwargs</span><span class="p">)</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


<form action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2015, Tom Aldcroft, Jean Connelly.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 3.1.2. &nbsp;
  </p>
</footer>
  </body>
</html>