
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>chandra_aca.maude_decom &#8212; chandra_aca 4.51.1 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../_static/documentation_options.js?v=0c4a43c0"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=30646c52"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/chandra_aca/maude_decom';</script>
    <link rel="canonical" href="https://sot.github.io/chandra_aca/_modules/chandra_aca/maude_decom.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="4.51.1" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item"><a href="../../index.html" style="text-decoration: none;">
    <span style="color: rgb(186, 70, 21); font-size: x-large;">chandra_aca</span>
</a>
&nbsp;
<span style="font-size: x-large;">4.51.1</span></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../aca_image.html">
    ACA images
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../maude_decom.html">
    MAUDE ACA telemetry
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api/index.html">
    API Reference
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/sot/chandra_aca" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../aca_image.html">
    ACA images
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../maude_decom.html">
    MAUDE ACA telemetry
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api/index.html">
    API Reference
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/sot/chandra_aca" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Module code</a></li>
    
    
    <li class="breadcrumb-item"><a href="../chandra_aca.html" class="nav-link">chandra_aca</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">chandra_aca.maude_decom</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for chandra_aca.maude_decom</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Classes and functions to help fetching ACA telemetry data using MAUDE.</span>

<span class="sd">See :ref:`maude_decom` for more details and examples.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">Struct</span>
<span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">unpack</span> <span class="k">as</span> <span class="n">_unpack</span>

<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">import</span> <span class="nn">maude</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">vstack</span>
<span class="kn">from</span> <span class="nn">cxotime</span> <span class="kn">import</span> <span class="n">CxoTime</span><span class="p">,</span> <span class="n">CxoTimeLike</span>

<span class="c1"># Maude fetch limits</span>
<div class="viewcode-block" id="MAUDE_SINGLE_FETCH_LIMIT">
<a class="viewcode-back" href="../../api/chandra_aca/maude_decom/index.html#chandra_aca.maude_decom.MAUDE_SINGLE_FETCH_LIMIT">[docs]</a>
<span class="n">MAUDE_SINGLE_FETCH_LIMIT</span> <span class="o">=</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">hour</span></div>

<div class="viewcode-block" id="MAUDE_FETCH_LIMIT">
<a class="viewcode-back" href="../../api/chandra_aca/maude_decom/index.html#chandra_aca.maude_decom.MAUDE_FETCH_LIMIT">[docs]</a>
<span class="n">MAUDE_FETCH_LIMIT</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">day</span></div>


<span class="c1"># maximum values for frame counters (for convenience)</span>
<div class="viewcode-block" id="MAX_MJF">
<a class="viewcode-back" href="../../api/chandra_aca/maude_decom/index.html#chandra_aca.maude_decom.MAX_MJF">[docs]</a>
<span class="n">MAX_MJF</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="MAX_MNF">
<a class="viewcode-back" href="../../api/chandra_aca/maude_decom/index.html#chandra_aca.maude_decom.MAX_MNF">[docs]</a>
<span class="n">MAX_MNF</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="MAX_VCDU">
<a class="viewcode-back" href="../../api/chandra_aca/maude_decom/index.html#chandra_aca.maude_decom.MAX_VCDU">[docs]</a>
<span class="n">MAX_VCDU</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span></div>


<span class="c1"># The following are the tables in the docstring above. They appear to be transposed,</span>
<span class="c1"># but the resultt agrees with level0.</span>
<div class="viewcode-block" id="PIXEL_MAP">
<a class="viewcode-back" href="../../api/chandra_aca/maude_decom/index.html#chandra_aca.maude_decom.PIXEL_MAP">[docs]</a>
<span class="n">PIXEL_MAP</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;4x4&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;A1&quot;</span><span class="p">,</span> <span class="s2">&quot;B1&quot;</span><span class="p">,</span> <span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="s2">&quot;D1&quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;E1&quot;</span><span class="p">,</span> <span class="s2">&quot;F1&quot;</span><span class="p">,</span> <span class="s2">&quot;G1&quot;</span><span class="p">,</span> <span class="s2">&quot;H1&quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;I1&quot;</span><span class="p">,</span> <span class="s2">&quot;J1&quot;</span><span class="p">,</span> <span class="s2">&quot;K1&quot;</span><span class="p">,</span> <span class="s2">&quot;L1&quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;M1&quot;</span><span class="p">,</span> <span class="s2">&quot;N1&quot;</span><span class="p">,</span> <span class="s2">&quot;O1&quot;</span><span class="p">,</span> <span class="s2">&quot;P1&quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">],</span>
        <span class="p">]</span>
    <span class="p">),</span>
    <span class="s2">&quot;6x6&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;A2&quot;</span><span class="p">,</span> <span class="s2">&quot;B2&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;D2&quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;P2&quot;</span><span class="p">,</span> <span class="s2">&quot;A1&quot;</span><span class="p">,</span> <span class="s2">&quot;B1&quot;</span><span class="p">,</span> <span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="s2">&quot;D1&quot;</span><span class="p">,</span> <span class="s2">&quot;E2&quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;O2&quot;</span><span class="p">,</span> <span class="s2">&quot;E1&quot;</span><span class="p">,</span> <span class="s2">&quot;F1&quot;</span><span class="p">,</span> <span class="s2">&quot;G1&quot;</span><span class="p">,</span> <span class="s2">&quot;H1&quot;</span><span class="p">,</span> <span class="s2">&quot;F2&quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;N2&quot;</span><span class="p">,</span> <span class="s2">&quot;I1&quot;</span><span class="p">,</span> <span class="s2">&quot;J1&quot;</span><span class="p">,</span> <span class="s2">&quot;K1&quot;</span><span class="p">,</span> <span class="s2">&quot;L1&quot;</span><span class="p">,</span> <span class="s2">&quot;G2&quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;M2&quot;</span><span class="p">,</span> <span class="s2">&quot;M1&quot;</span><span class="p">,</span> <span class="s2">&quot;N1&quot;</span><span class="p">,</span> <span class="s2">&quot;O1&quot;</span><span class="p">,</span> <span class="s2">&quot;P1&quot;</span><span class="p">,</span> <span class="s2">&quot;H2&quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;L2&quot;</span><span class="p">,</span> <span class="s2">&quot;K2&quot;</span><span class="p">,</span> <span class="s2">&quot;J2&quot;</span><span class="p">,</span> <span class="s2">&quot;I2&quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">],</span>
        <span class="p">]</span>
    <span class="p">),</span>
    <span class="s2">&quot;8x8&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;A1&quot;</span><span class="p">,</span> <span class="s2">&quot;B1&quot;</span><span class="p">,</span> <span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="s2">&quot;D1&quot;</span><span class="p">,</span> <span class="s2">&quot;E1&quot;</span><span class="p">,</span> <span class="s2">&quot;F1&quot;</span><span class="p">,</span> <span class="s2">&quot;G1&quot;</span><span class="p">,</span> <span class="s2">&quot;H1&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;I1&quot;</span><span class="p">,</span> <span class="s2">&quot;J1&quot;</span><span class="p">,</span> <span class="s2">&quot;K1&quot;</span><span class="p">,</span> <span class="s2">&quot;L1&quot;</span><span class="p">,</span> <span class="s2">&quot;M1&quot;</span><span class="p">,</span> <span class="s2">&quot;N1&quot;</span><span class="p">,</span> <span class="s2">&quot;O1&quot;</span><span class="p">,</span> <span class="s2">&quot;P1&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;A2&quot;</span><span class="p">,</span> <span class="s2">&quot;B2&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;D2&quot;</span><span class="p">,</span> <span class="s2">&quot;E2&quot;</span><span class="p">,</span> <span class="s2">&quot;F2&quot;</span><span class="p">,</span> <span class="s2">&quot;G2&quot;</span><span class="p">,</span> <span class="s2">&quot;H2&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;I2&quot;</span><span class="p">,</span> <span class="s2">&quot;J2&quot;</span><span class="p">,</span> <span class="s2">&quot;K2&quot;</span><span class="p">,</span> <span class="s2">&quot;L2&quot;</span><span class="p">,</span> <span class="s2">&quot;M2&quot;</span><span class="p">,</span> <span class="s2">&quot;N2&quot;</span><span class="p">,</span> <span class="s2">&quot;O2&quot;</span><span class="p">,</span> <span class="s2">&quot;P2&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;A3&quot;</span><span class="p">,</span> <span class="s2">&quot;B3&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="s2">&quot;D3&quot;</span><span class="p">,</span> <span class="s2">&quot;E3&quot;</span><span class="p">,</span> <span class="s2">&quot;F3&quot;</span><span class="p">,</span> <span class="s2">&quot;G3&quot;</span><span class="p">,</span> <span class="s2">&quot;H3&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;I3&quot;</span><span class="p">,</span> <span class="s2">&quot;J3&quot;</span><span class="p">,</span> <span class="s2">&quot;K3&quot;</span><span class="p">,</span> <span class="s2">&quot;L3&quot;</span><span class="p">,</span> <span class="s2">&quot;M3&quot;</span><span class="p">,</span> <span class="s2">&quot;N3&quot;</span><span class="p">,</span> <span class="s2">&quot;O3&quot;</span><span class="p">,</span> <span class="s2">&quot;P3&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;A4&quot;</span><span class="p">,</span> <span class="s2">&quot;B4&quot;</span><span class="p">,</span> <span class="s2">&quot;C4&quot;</span><span class="p">,</span> <span class="s2">&quot;D4&quot;</span><span class="p">,</span> <span class="s2">&quot;E4&quot;</span><span class="p">,</span> <span class="s2">&quot;F4&quot;</span><span class="p">,</span> <span class="s2">&quot;G4&quot;</span><span class="p">,</span> <span class="s2">&quot;H4&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;I4&quot;</span><span class="p">,</span> <span class="s2">&quot;J4&quot;</span><span class="p">,</span> <span class="s2">&quot;K4&quot;</span><span class="p">,</span> <span class="s2">&quot;L4&quot;</span><span class="p">,</span> <span class="s2">&quot;M4&quot;</span><span class="p">,</span> <span class="s2">&quot;N4&quot;</span><span class="p">,</span> <span class="s2">&quot;O4&quot;</span><span class="p">,</span> <span class="s2">&quot;P4&quot;</span><span class="p">],</span>
        <span class="p">]</span>
    <span class="p">),</span>
    <span class="s2">&quot;DNLD&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">],</span>
        <span class="p">]</span>
    <span class="p">),</span>
<span class="p">}</span></div>


<div class="viewcode-block" id="PIXEL_MASK">
<a class="viewcode-back" href="../../api/chandra_aca/maude_decom/index.html#chandra_aca.maude_decom.PIXEL_MASK">[docs]</a>
<span class="n">PIXEL_MASK</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">PIXEL_MAP</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;  &quot;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">PIXEL_MAP</span><span class="p">}</span></div>

<span class="n">_ROWS</span><span class="p">,</span> <span class="n">_COLS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="PIXEL_MAP_INV">
<a class="viewcode-back" href="../../api/chandra_aca/maude_decom/index.html#chandra_aca.maude_decom.PIXEL_MAP_INV">[docs]</a>
<span class="n">PIXEL_MAP_INV</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">k</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">p</span><span class="p">:</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">_ROWS</span><span class="p">[</span><span class="n">PIXEL_MAP</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;  &quot;</span><span class="p">],</span>
            <span class="n">_COLS</span><span class="p">[</span><span class="n">PIXEL_MAP</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;  &quot;</span><span class="p">],</span>
            <span class="n">PIXEL_MAP</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">PIXEL_MAP</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;  &quot;</span><span class="p">],</span>
            <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;6x6&quot;</span><span class="p">,</span> <span class="s2">&quot;4x4&quot;</span><span class="p">,</span> <span class="s2">&quot;8x8&quot;</span><span class="p">]</span>
<span class="p">}</span></div>



<div class="viewcode-block" id="_msid_prefix">
<a class="viewcode-back" href="../../api/chandra_aca/maude_decom/index.html#chandra_aca.maude_decom._msid_prefix">[docs]</a>
<span class="n">_msid_prefix</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;R&quot;</span><span class="p">}</span></div>



<span class="k">def</span> <span class="nf">_aca_msid_list</span><span class="p">(</span><span class="n">pea</span><span class="p">):</span>
    <span class="c1"># helper method to make a dictionary with all global (non-slot) MSIDs used here</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;AOACSTAT&quot;</span><span class="p">,</span>  <span class="c1"># ASPECT CAMERA DATA PROCESSING OVERALL STATUS FLAG</span>
        <span class="s2">&quot;integration_time&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_msid_prefix</span><span class="p">[</span><span class="n">pea</span><span class="p">]</span><span class="si">}</span><span class="s2">ACAINT0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;major_frame&quot;</span><span class="p">:</span> <span class="s2">&quot;CVCMJCTR&quot;</span><span class="p">,</span>
        <span class="s2">&quot;minor_frame&quot;</span><span class="p">:</span> <span class="s2">&quot;CVCMNCTR&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cmd_count&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_msid_prefix</span><span class="p">[</span><span class="n">pea</span><span class="p">]</span><span class="si">}</span><span class="s2">CCMDS&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cmd_progress_to_go&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_msid_prefix</span><span class="p">[</span><span class="n">pea</span><span class="p">]</span><span class="si">}</span><span class="s2">AROW2GO&quot;</span><span class="p">,</span>  <span class="c1"># No. of ROWS TO GO COMMAND PROGRESS</span>
        <span class="s2">&quot;cmd_progress&quot;</span><span class="p">:</span> <span class="s2">&quot;AOCMDPG1&quot;</span><span class="p">,</span>  <span class="c1"># COMMAND PROGRESS COUNT</span>
        <span class="s2">&quot;pixel_telemetry_type&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_msid_prefix</span><span class="p">[</span><span class="n">pea</span><span class="p">]</span><span class="si">}</span><span class="s2">APIXTLM&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dynamic_background_type&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_msid_prefix</span><span class="p">[</span><span class="n">pea</span><span class="p">]</span><span class="si">}</span><span class="s2">ABGDTYP&quot;</span><span class="p">,</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">_aca_image_msid_list</span><span class="p">(</span><span class="n">pea</span><span class="p">):</span>
    <span class="c1"># helper method to make a list of dictionaries with MSIDs for each slot in a given PEA.</span>
    <span class="n">msid_prefix</span> <span class="o">=</span> <span class="n">_msid_prefix</span><span class="p">[</span><span class="n">pea</span><span class="p">]</span>

    <span class="n">px_ids</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;A&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B&quot;</span><span class="p">,</span>
        <span class="s2">&quot;C&quot;</span><span class="p">,</span>
        <span class="s2">&quot;D&quot;</span><span class="p">,</span>
        <span class="s2">&quot;E&quot;</span><span class="p">,</span>
        <span class="s2">&quot;F&quot;</span><span class="p">,</span>
        <span class="s2">&quot;G&quot;</span><span class="p">,</span>
        <span class="s2">&quot;H&quot;</span><span class="p">,</span>
        <span class="s2">&quot;I&quot;</span><span class="p">,</span>
        <span class="s2">&quot;J&quot;</span><span class="p">,</span>
        <span class="s2">&quot;K&quot;</span><span class="p">,</span>
        <span class="s2">&quot;L&quot;</span><span class="p">,</span>
        <span class="s2">&quot;M&quot;</span><span class="p">,</span>
        <span class="s2">&quot;N&quot;</span><span class="p">,</span>
        <span class="s2">&quot;O&quot;</span><span class="p">,</span>
        <span class="s2">&quot;P&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">px_nums</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)]</span>
    <span class="n">px_img_nums</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)]</span>

    <span class="n">pixels</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">sorted</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CIMG</span><span class="si">{</span><span class="n">px_img_num</span><span class="si">}{</span><span class="n">px_id</span><span class="si">}{</span><span class="n">px_num</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">for</span> <span class="n">px_num</span> <span class="ow">in</span> <span class="n">px_nums</span>
                <span class="k">for</span> <span class="n">px_id</span> <span class="ow">in</span> <span class="n">px_ids</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">px_img_num</span> <span class="ow">in</span> <span class="n">px_img_nums</span>
    <span class="p">]</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;pixels&quot;</span><span class="p">:</span> <span class="n">pixels</span><span class="p">,</span>
        <span class="s2">&quot;sizes&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA00040&quot;</span><span class="p">,</span>  <span class="c1"># Size of image 0</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA00043&quot;</span><span class="p">,</span>  <span class="c1"># Size of image 1</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA00046&quot;</span><span class="p">,</span>  <span class="c1"># Size of image 2</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA00049&quot;</span><span class="p">,</span>  <span class="c1"># Size of image 3</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA00052&quot;</span><span class="p">,</span>  <span class="c1"># Size of image 4</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA00055&quot;</span><span class="p">,</span>  <span class="c1"># Size of image 5</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA00058&quot;</span><span class="p">,</span>  <span class="c1"># Size of image 6</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA00061&quot;</span><span class="p">,</span>
        <span class="p">],</span>  <span class="c1"># Size of image 7</span>
        <span class="s2">&quot;rows&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA00076&quot;</span><span class="p">,</span>  <span class="c1"># Row of pixel A1 of image 0</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA00292&quot;</span><span class="p">,</span>  <span class="c1"># Row of pixel A1 of image 1</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA00508&quot;</span><span class="p">,</span>  <span class="c1"># Row of pixel A1 of image 2</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA00724&quot;</span><span class="p">,</span>  <span class="c1"># Row of pixel A1 of image 3</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA00940&quot;</span><span class="p">,</span>  <span class="c1"># Row of pixel A1 of image 4</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA01156&quot;</span><span class="p">,</span>  <span class="c1"># Row of pixel A1 of image 5</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA01372&quot;</span><span class="p">,</span>  <span class="c1"># Row of pixel A1 of image 6</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA01588&quot;</span><span class="p">,</span>
        <span class="p">],</span>  <span class="c1"># Row of pixel A1 of image 7</span>
        <span class="s2">&quot;cols&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA00086&quot;</span><span class="p">,</span>  <span class="c1"># Column of pixel A1 of image 0</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA00302&quot;</span><span class="p">,</span>  <span class="c1"># Column of pixel A1 of image 1</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA00518&quot;</span><span class="p">,</span>  <span class="c1"># Column of pixel A1 of image 2</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA00734&quot;</span><span class="p">,</span>  <span class="c1"># Column of pixel A1 of image 3</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA00950&quot;</span><span class="p">,</span>  <span class="c1"># Column of pixel A1 of image 4</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA01166&quot;</span><span class="p">,</span>  <span class="c1"># Column of pixel A1 of image 5</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA01382&quot;</span><span class="p">,</span>  <span class="c1"># Column of pixel A1 of image 6</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA01598&quot;</span><span class="p">,</span>
        <span class="p">],</span>  <span class="c1"># Column of pixel A1 of image 7</span>
        <span class="s2">&quot;scale_factor&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA00096&quot;</span><span class="p">,</span>  <span class="c1"># Scale factor of image 0</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA00312&quot;</span><span class="p">,</span>  <span class="c1"># Scale factor of image 1</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA00528&quot;</span><span class="p">,</span>  <span class="c1"># Scale factor of image 2</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA00744&quot;</span><span class="p">,</span>  <span class="c1"># Scale factor of image 3</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA00960&quot;</span><span class="p">,</span>  <span class="c1"># Scale factor of image 4</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA01176&quot;</span><span class="p">,</span>  <span class="c1"># Scale factor of image 5</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA01392&quot;</span><span class="p">,</span>  <span class="c1"># Scale factor of image 6</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA01608&quot;</span><span class="p">,</span>
        <span class="p">],</span>  <span class="c1"># Scale factor of image 7</span>
        <span class="s2">&quot;image_status&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;AOIMAGE</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)],</span>  <span class="c1"># IMAGE STATUS FLAG</span>
        <span class="s2">&quot;fiducial_flag&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;AOACFID</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)],</span>  <span class="c1"># FIDUCIAL LIGHT FLAG (OBC)</span>
        <span class="s2">&quot;image_function_obc&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;AOACFCT</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)],</span>  <span class="c1"># IMAGE FUNCTION (OBC)</span>
        <span class="s2">&quot;image_function&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">AIMGF</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">1&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="p">],</span>  <span class="c1"># IMAGE FUNCTION (PEA)</span>
        <span class="c1"># this one exists also as FUNCTION2/3/4</span>
        <span class="c1"># &#39;image_function&#39;:</span>
        <span class="c1">#     [f&#39;{msid_prefix}AIMGF{i}1&#39; for i in range(8)],  # IMAGE FUNCTION1 (PEA)</span>
        <span class="s2">&quot;saturated_pixel&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">ASPXF</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="p">],</span>  <span class="c1"># DEFECTIVE PIXEL FLAG</span>
        <span class="s2">&quot;defective_pixel&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">ADPXF</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="p">],</span>  <span class="c1"># SATURATED PIXEL FLAG</span>
        <span class="s2">&quot;quad_bound&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">QBNDF</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="p">],</span>  <span class="c1"># QUADRANT BOUNDRY FLAG</span>
        <span class="s2">&quot;common_col&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">ACOLF</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="p">],</span>  <span class="c1"># COMMON COLUMN FLAG</span>
        <span class="s2">&quot;multi_star&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">AMSTF</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="p">],</span>  <span class="c1"># MULTIPLE STAR FLAG</span>
        <span class="s2">&quot;ion_rad&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">AIRDF</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="p">],</span>  <span class="c1"># IONIZING RADIATION FLAG</span>
        <span class="s2">&quot;background_rms&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CRMSBG</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)],</span>
        <span class="s2">&quot;background_avg&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA00110&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA00326&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA00542&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA00758&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA00974&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA01190&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA01406&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CA01622&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s2">&quot;housing_temperature&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">ACH1T</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">2&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="p">],</span>  <span class="c1"># AC HOUSING TEMPERATURE</span>
        <span class="s2">&quot;ccd_temperature&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">CCDPT</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">2&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="p">],</span>  <span class="c1"># CCD TEMPERATURE</span>
        <span class="s2">&quot;primary_temperature&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">QTAPMT</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="p">],</span>  <span class="c1"># PRIMARY MIRROR/LENS CELL TEMP</span>
        <span class="s2">&quot;secondary_temperature&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msid_prefix</span><span class="si">}</span><span class="s2">QTH2MT</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="p">],</span>  <span class="c1"># AC SECONDARY MIRROR TEMPERATURE</span>
        <span class="s2">&quot;magnitude&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;AOACMAG</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="p">],</span>  <span class="c1"># STAR OR FIDUCIAL MAGNITUDE (OBC)</span>
        <span class="s2">&quot;centroid_ang_y&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;AOACYAN</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="p">],</span>  <span class="c1"># YAG CENTROID Y ANGLE (OBC)</span>
        <span class="s2">&quot;centroid_ang_z&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;AOACZAN</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="p">],</span>  <span class="c1"># ZAG CENTROID Z ANGLE (OBC)</span>
        <span class="s2">&quot;bgd_stat_pixels&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;ACBPX</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">1</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="s2">&quot;ABGH&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;ACBPX</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">4</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="s2">&quot;IJOP&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="p">],</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">[{</span><span class="n">k</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">res</span><span class="p">}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)]</span>


<div class="viewcode-block" id="ACA_MSID_LIST">
<a class="viewcode-back" href="../../api/chandra_aca/maude_decom/index.html#chandra_aca.maude_decom.ACA_MSID_LIST">[docs]</a>
<span class="n">ACA_MSID_LIST</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span> <span class="n">_aca_msid_list</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)}</span></div>

<div class="viewcode-block" id="ACA_SLOT_MSID_LIST">
<a class="viewcode-back" href="../../api/chandra_aca/maude_decom/index.html#chandra_aca.maude_decom.ACA_SLOT_MSID_LIST">[docs]</a>
<span class="n">ACA_SLOT_MSID_LIST</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span> <span class="n">_aca_image_msid_list</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)}</span></div>



<div class="viewcode-block" id="_a2p">
<a class="viewcode-back" href="../../api/chandra_aca/maude_decom/index.html#chandra_aca.maude_decom._a2p">[docs]</a>
<span class="n">_a2p</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="s2">&quot;J&quot;</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">,</span> <span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;O&quot;</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">]</span></div>

<span class="c1"># This maps image type to a list of pixel indices over the 8x8 array.</span>
<span class="c1"># - Type 0 is 4x4,</span>
<span class="c1"># - Types 1 (first batch of 6x6) and 4 (first batch of 8x8) use the same pixel IDs as 4x4.</span>
<span class="c1"># - Type 3 is not a real image type. It occurs when the image telemetry is used to download</span>
<span class="c1">#   memory dump data. In this case, the image is treated as 4x4, but the values might be giberish.</span>
<span class="c1"># - Types 2 (second batch of 6x6) and 5 (second batch of 8x8) use the same pixel IDs.</span>
<div class="viewcode-block" id="_IMG_INDICES">
<a class="viewcode-back" href="../../api/chandra_aca/maude_decom/index.html#chandra_aca.maude_decom._IMG_INDICES">[docs]</a>
<span class="n">_IMG_INDICES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">PIXEL_MAP_INV</span><span class="p">[</span><span class="s2">&quot;4x4&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">1&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_a2p</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">PIXEL_MAP_INV</span><span class="p">[</span><span class="s2">&quot;6x6&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">1&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_a2p</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">PIXEL_MAP_INV</span><span class="p">[</span><span class="s2">&quot;6x6&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">2&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_a2p</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">PIXEL_MAP_INV</span><span class="p">[</span><span class="s2">&quot;4x4&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">1&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_a2p</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">PIXEL_MAP_INV</span><span class="p">[</span><span class="s2">&quot;8x8&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">1&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_a2p</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">PIXEL_MAP_INV</span><span class="p">[</span><span class="s2">&quot;8x8&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">2&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_a2p</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">PIXEL_MAP_INV</span><span class="p">[</span><span class="s2">&quot;8x8&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">3&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_a2p</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">PIXEL_MAP_INV</span><span class="p">[</span><span class="s2">&quot;8x8&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">4&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_a2p</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
<span class="p">]</span></div>


<span class="c1">######################</span>
<span class="c1"># VCDU-based functions</span>
<span class="c1">######################</span>

<span class="c1"># these are used multiple times</span>
<div class="viewcode-block" id="_aca_front_fmt">
<a class="viewcode-back" href="../../api/chandra_aca/maude_decom/index.html#chandra_aca.maude_decom._aca_front_fmt">[docs]</a>
<span class="n">_aca_front_fmt</span> <span class="o">=</span> <span class="n">Struct</span><span class="p">(</span><span class="s2">&quot;&gt;HBBBBBB&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="_size_bits">
<a class="viewcode-back" href="../../api/chandra_aca/maude_decom/index.html#chandra_aca.maude_decom._size_bits">[docs]</a>
<span class="n">_size_bits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span></div>

<div class="viewcode-block" id="_pixel_bits">
<a class="viewcode-back" href="../../api/chandra_aca/maude_decom/index.html#chandra_aca.maude_decom._pixel_bits">[docs]</a>
<span class="n">_pixel_bits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span></div>

<div class="viewcode-block" id="_bits">
<a class="viewcode-back" href="../../api/chandra_aca/maude_decom/index.html#chandra_aca.maude_decom._bits">[docs]</a>
<span class="n">_bits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">64</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>



<span class="c1"># I&#39;m sure there is a better way...</span>
<span class="k">def</span> <span class="nf">_packbits</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">unsigned</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="c1"># take something like this: [1,0,1,1,0] and return 2^4 + 2^2 + 2</span>
    <span class="c1"># This handles integer types only</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">unsigned</span> <span class="ow">and</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">_bits</span><span class="p">[</span><span class="o">-</span><span class="n">n</span><span class="p">:])</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">n</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">_bits</span><span class="p">[</span><span class="o">-</span><span class="n">n</span><span class="p">:])</span>


<span class="k">class</span> <span class="nc">_AcaImageHeaderDecom</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to decommute ACA image telemtry headers.</span>

<span class="sd">    These methods are grouped into a class because header 3 packet is split into up to 8 parts.</span>
<span class="sd">    The __call__ method in this class accumulates the partial packets. Once all images are of known</span>
<span class="sd">    types, and the packets are known, it will return the header 3 data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_header</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_aca_header_1</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_aca_header_1</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_aca_header_2</span><span class="p">,</span>
            <span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="p">{},</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_aca_header_1</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_aca_header_2</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_aca_header_3</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_aca_header_3</span><span class="p">,</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imgnum</span><span class="p">,</span> <span class="n">imgtype</span><span class="p">,</span> <span class="n">byte_array</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="n">imgtype</span><span class="p">](</span><span class="n">byte_array</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_aca_header_1</span><span class="p">(</span><span class="n">bits</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Unpack ACA header 1 (ACA User Manual 5.3.2.2.1).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bits</span>
<span class="sd">            bytes-like object of length 7</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unpackbits</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_unpack</span><span class="p">(</span><span class="s2">&quot;BBBBBBB&quot;</span><span class="p">,</span> <span class="n">bits</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;IMGFID&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="s2">&quot;IMGNUM&quot;</span><span class="p">:</span> <span class="n">_packbits</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]),</span>
            <span class="s2">&quot;IMGFUNC&quot;</span><span class="p">:</span> <span class="n">_packbits</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]),</span>
            <span class="s2">&quot;IMGSTAT&quot;</span><span class="p">:</span> <span class="n">_packbits</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">12</span><span class="p">]),</span>
            <span class="s2">&quot;SAT_PIXEL&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">6</span><span class="p">]),</span>
            <span class="s2">&quot;DEF_PIXEL&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">7</span><span class="p">]),</span>
            <span class="s2">&quot;QUAD_BOUND&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">8</span><span class="p">]),</span>
            <span class="s2">&quot;COMMON_COL&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">9</span><span class="p">]),</span>
            <span class="s2">&quot;MULTI_STAR&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">10</span><span class="p">]),</span>
            <span class="s2">&quot;ION_RAD&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">11</span><span class="p">]),</span>
            <span class="s2">&quot;IMGROW0&quot;</span><span class="p">:</span> <span class="n">_packbits</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">22</span><span class="p">],</span> <span class="n">unsigned</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="s2">&quot;IMGCOL0&quot;</span><span class="p">:</span> <span class="n">_packbits</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">22</span><span class="p">:</span><span class="mi">32</span><span class="p">],</span> <span class="n">unsigned</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="s2">&quot;IMGSCALE&quot;</span><span class="p">:</span> <span class="n">_packbits</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">32</span><span class="p">:</span><span class="mi">46</span><span class="p">]),</span>
            <span class="s2">&quot;BGDAVG&quot;</span><span class="p">:</span> <span class="n">_packbits</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">46</span><span class="p">:</span><span class="mi">56</span><span class="p">]),</span>
        <span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_aca_header_2</span><span class="p">(</span><span class="n">bits</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Unpack ACA header 2 (ACA User Manual 5.3.2.2.2).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bits</span>
<span class="sd">            bytes-like object of length 7</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">_unpack</span><span class="p">(</span><span class="s2">&quot;BBbbbbB&quot;</span><span class="p">,</span> <span class="n">bits</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unpackbits</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="c1"># do we want these?</span>
            <span class="c1"># &#39;FID2&#39;: bool(values[0]),</span>
            <span class="c1"># &#39;IMGNUM2&#39;: _packbits(values[1:4]),</span>
            <span class="c1"># &#39;IMGFUNC2&#39;: _packbits(values[4:6]),</span>
            <span class="s2">&quot;BGDRMS&quot;</span><span class="p">:</span> <span class="n">_packbits</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">16</span><span class="p">]),</span>
            <span class="s2">&quot;TEMPCCD&quot;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="s2">&quot;TEMPHOUS&quot;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="s2">&quot;TEMPPRIM&quot;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
            <span class="s2">&quot;TEMPSEC&quot;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
            <span class="s2">&quot;BGDSTAT&quot;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
            <span class="s2">&quot;BGDSTAT_PIXELS&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">unpackbits</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]),</span>
        <span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_aca_header_3</span><span class="p">(</span><span class="n">bits</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Unpack ACA header 3 (ACA User Manual 5.3.2.2.3).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bits</span>
<span class="sd">            bytes-like object of length 7</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;DIAGNOSTIC&quot;</span><span class="p">:</span> <span class="n">_unpack</span><span class="p">(</span><span class="s2">&quot;BBBBBB&quot;</span><span class="p">,</span> <span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">:])}</span>


<span class="k">def</span> <span class="nf">unpack_aca_telemetry</span><span class="p">(</span><span class="n">packet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Unpack ACA telemetry encoded in 225-byte packets.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    packet</span>
<span class="sd">        bytes</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of dict</span>
<span class="sd">    A list of length 8, one entry per slot, where each entry is a dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">s3</span> <span class="o">=</span> <span class="n">_unpack</span><span class="p">(</span><span class="s2">&quot;BBB&quot;</span><span class="p">,</span> <span class="n">packet</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span>
    <span class="n">_size_bits</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unpackbits</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">s3</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">8</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">img_types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">packbits</span><span class="p">(</span><span class="n">_size_bits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">slots</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">header_decom</span> <span class="o">=</span> <span class="n">_AcaImageHeaderDecom</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">img_num</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">packet</span><span class="p">),</span> <span class="mi">27</span><span class="p">)):</span>
        <span class="n">img_header</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;IMGTYPE&quot;</span><span class="p">:</span> <span class="n">img_types</span><span class="p">[</span><span class="n">img_num</span><span class="p">]}</span>
        <span class="n">img_header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">header_decom</span><span class="p">(</span><span class="n">img_num</span><span class="p">,</span> <span class="n">img_types</span><span class="p">[</span><span class="n">img_num</span><span class="p">],</span> <span class="n">packet</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">7</span><span class="p">]))</span>
        <span class="n">img_pixels</span> <span class="o">=</span> <span class="n">_unpack</span><span class="p">(</span><span class="s2">&quot;B&quot;</span> <span class="o">*</span> <span class="mi">20</span><span class="p">,</span> <span class="n">packet</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">7</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">27</span><span class="p">])</span>
        <span class="n">_pixel_bits</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">10</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unpackbits</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">img_pixels</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">img_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">packbits</span><span class="p">(</span><span class="n">_pixel_bits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">[[</span><span class="mi">2</span><span class="o">**</span><span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">img_header</span><span class="p">[</span><span class="s2">&quot;pixels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_pixels</span>
        <span class="n">slots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img_header</span><span class="p">)</span>

    <span class="n">bgd_types</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;FLAT&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;DYNB&quot;</span><span class="p">}</span>
    <span class="n">pix_tlm_types</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;ORIG&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;DYNB&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;DIFF&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s2">&quot;ERR3&quot;</span><span class="p">}</span>
    <span class="c1"># Before the dynamic background patch, the first two bytes contained INTEG in those</span>
    <span class="c1"># 16 bits (named integbits).  After the dynamic background patch, the first 6 bits of</span>
    <span class="c1"># integbits will be repurposed: two bits for PIXTLM, next bit for BGDTYP, 3 spares,</span>
    <span class="c1"># and 10 bits for INTEG.</span>
    <span class="n">integbits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unpackbits</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_unpack</span><span class="p">(</span><span class="s2">&quot;BB&quot;</span><span class="p">,</span> <span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
    <span class="n">pixtlm</span> <span class="o">=</span> <span class="n">_packbits</span><span class="p">(</span><span class="n">integbits</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">bgdtyp</span> <span class="o">=</span> <span class="n">integbits</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">integ</span> <span class="o">=</span> <span class="n">_packbits</span><span class="p">(</span><span class="n">integbits</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span>
    <span class="n">glbstat</span> <span class="o">=</span> <span class="n">_unpack</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">bits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unpackbits</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_unpack</span><span class="p">(</span><span class="s2">&quot;BBB&quot;</span><span class="p">,</span> <span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;AAPIXTLM&quot;</span><span class="p">:</span> <span class="n">pix_tlm_types</span><span class="p">[</span><span class="n">pixtlm</span><span class="p">],</span>
        <span class="s2">&quot;AABGDTYP&quot;</span><span class="p">:</span> <span class="n">bgd_types</span><span class="p">[</span><span class="n">bgdtyp</span><span class="p">],</span>
        <span class="s2">&quot;INTEG&quot;</span><span class="p">:</span> <span class="n">integ</span><span class="p">,</span>
        <span class="s2">&quot;GLBSTAT&quot;</span><span class="p">:</span> <span class="n">glbstat</span><span class="p">,</span>
        <span class="s2">&quot;HIGH_BGD&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="s2">&quot;RAM_FAIL&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="s2">&quot;ROM_FAIL&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
        <span class="s2">&quot;POWER_FAIL&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
        <span class="s2">&quot;CAL_FAIL&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span>
        <span class="s2">&quot;COMM_CHECKSUM_FAIL&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span>
        <span class="s2">&quot;RESET&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">6</span><span class="p">]),</span>
        <span class="s2">&quot;SYNTAX_ERROR&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">7</span><span class="p">]),</span>
        <span class="s2">&quot;COMMCNT&quot;</span><span class="p">:</span> <span class="n">_packbits</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">14</span><span class="p">],</span> <span class="n">unsigned</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="s2">&quot;COMMCNT_SYNTAX_ERROR&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">14</span><span class="p">]),</span>
        <span class="s2">&quot;COMMCNT_CHECKSUM_FAIL&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">15</span><span class="p">]),</span>
        <span class="s2">&quot;COMMPROG&quot;</span><span class="p">:</span> <span class="n">_packbits</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="mi">22</span><span class="p">],</span> <span class="n">unsigned</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="s2">&quot;COMMPROG_REPEAT&quot;</span><span class="p">:</span> <span class="n">_packbits</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">22</span><span class="p">:</span><span class="mi">24</span><span class="p">],</span> <span class="n">unsigned</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">slots</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">slots</span>


<span class="k">def</span> <span class="nf">_combine_aca_packets</span><span class="p">(</span><span class="n">aca_packets</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combine a list of ACA packets into a single record.</span>

<span class="sd">    This is intended to combine the two 6X6 packets or the four 8X8 packets.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    aca_packets</span>
<span class="sd">        list of dict</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># note that they are reverse-sorted so the first frame overwrites the others if they collide</span>
    <span class="n">aca_packets</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">aca_packets</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;TIME&quot;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_all</span><span class="p">((</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">pixels</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">aca_packets</span><span class="p">:</span>
        <span class="c1"># IMGTYPE 3 is not a real image. It means the pixels are used to download memory dump data</span>
        <span class="c1"># if IMGTYPE == 3, do nothing. All pixels will be masked</span>
        <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;IMGTYPE&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">i0</span><span class="p">,</span> <span class="n">i1</span> <span class="o">=</span> <span class="n">_IMG_INDICES</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s2">&quot;IMGTYPE&quot;</span><span class="p">]]</span>
            <span class="n">pixels</span><span class="p">[</span><span class="n">i0</span><span class="p">,</span> <span class="n">i1</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;pixels&quot;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">aca_packets</span><span class="p">:</span>
        <span class="n">res</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;pixels&quot;</span><span class="p">]</span>
    <span class="n">res</span><span class="p">[</span><span class="s2">&quot;IMG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pixels</span>
    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">_group_packets</span><span class="p">(</span><span class="n">packets</span><span class="p">,</span> <span class="n">discard</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Group ACA image telemetry packets to form full images.</span>

<span class="sd">    ACA telemetry is packed in packets of 225 bytes, and each of these is split in four VCDU frames.</span>
<span class="sd">    Each ACA telemetry packet includes pixel telemetry for 16 pixels in each of the 8 slots.</span>
<span class="sd">    A 4x4 image is complete in one packet, whereas 6x6 and 8x8 images are split into two and four</span>
<span class="sd">    packets respectively.</span>

<span class="sd">    This function takes a list of dictionaries, with each dictionary containing the pixel</span>
<span class="sd">    telemetry for one slot in a VCDU frame. Each dictionary must have the keys &#39;MJF&#39;, &#39;MNF&#39;</span>
<span class="sd">    and &#39;IMGTYPE&#39;. It returns a list of lists of dicts, where each list of dicts contains the pixel</span>
<span class="sd">    telemetry for a full image.</span>

<span class="sd">    The function assumes:</span>
<span class="sd">    - all entries correspond to the same slot</span>
<span class="sd">    - the entries are ordered by increasing VCDU counter</span>
<span class="sd">    - missing/repeated VCDU counters have been removed</span>

<span class="sd">    If this is not the case, the results will be incorrect.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    packets</span>
<span class="sd">        list of ACA sub-packets</span>
<span class="sd">    discard</span>
<span class="sd">        bool to discard incomplete ACA packets</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of ACA packets</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">rollover</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">packet</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">packets</span><span class="p">):</span>
        <span class="n">vcdu</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="s2">&quot;MJF&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">128</span> <span class="o">+</span> <span class="n">packet</span><span class="p">[</span><span class="s2">&quot;MNF&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">packets</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;MJF&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">128</span> <span class="o">+</span> <span class="n">packets</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;MNF&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">vcdu</span><span class="p">:</span>
            <span class="n">rollover</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">vcdu</span> <span class="o">+=</span> <span class="n">rollover</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span>
        <span class="k">if</span> <span class="n">vcdu</span> <span class="o">&gt;</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">res</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">discard</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">res</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">:</span>
            <span class="c1"># the number of minor frames expected within the same ACA packet</span>
            <span class="n">s</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">:</span> <span class="mi">4</span><span class="p">}[</span><span class="nb">int</span><span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="s2">&quot;IMGTYPE&quot;</span><span class="p">])]</span>
            <span class="c1"># the number of minor frames within the same ACA packet expected after this minor frame</span>
            <span class="n">remaining</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">:</span> <span class="mi">0</span><span class="p">}[</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="s2">&quot;IMGTYPE&quot;</span><span class="p">])</span>
            <span class="p">]</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">vcdu</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">remaining</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vcdu</span> <span class="o">==</span> <span class="n">n</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">res</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">discard</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">filter_vcdu_jumps</span><span class="p">(</span><span class="n">vcdu_counters</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a boolean mask to filter VCDU counters that are not continuous.</span>

<span class="sd">    The returned mask ensures that::</span>

<span class="sd">        - VCDU counters are a strictly monotonic sequence.</span>
<span class="sd">        - VCDU counters come in packets of four, with each group starting with a multiple of 4.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">current_packet</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># to group in fours</span>
    <span class="n">last_frame</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># for monotonicity check</span>
    <span class="n">selected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vcdu_counters</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">vcdu_counter</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vcdu_counters</span><span class="p">):</span>
        <span class="c1"># major frame counter rolls over at 2**17, and minor counter at 2**7</span>
        <span class="c1"># The VCDU counter (which includes both) rolls over at 2**24 (16777216).</span>
        <span class="c1"># The VCDU counter must increase or roll over (in which case it jumps by a large negative</span>
        <span class="c1"># number) In the worse case, it rolls over _and_ 3600*4 frames are missing</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="n">last_frame</span> <span class="o">&lt;</span> <span class="n">vcdu_counter</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">vcdu_counter</span> <span class="o">-</span> <span class="n">last_frame</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="p">(</span><span class="mi">16777215</span> <span class="o">-</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">last_frame</span> <span class="o">=</span> <span class="n">vcdu_counter</span>
            <span class="k">continue</span>
        <span class="n">last_frame</span> <span class="o">=</span> <span class="n">vcdu_counter</span>
        <span class="k">if</span> <span class="n">vcdu_counter</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">current_packet</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">current_packet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vcdu_counter</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_packet</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">selected</span><span class="p">[</span><span class="n">current_packet</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">selected</span>


<span class="k">def</span> <span class="nf">get_raw_aca_packets</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">maude_result</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">maude_kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetch 1025-byte VCDU frames using MAUDE and extract a list of 225-byte ACA packets.</span>

<span class="sd">    If the first minor frame in a group of four ACA packets is within (start, stop),</span>
<span class="sd">    the three following minor frames are included if present.</span>

<span class="sd">    returns a dictionary with keys [&#39;TIME&#39;, &#39;MNF&#39;, &#39;MJF&#39;, &#39;packets&#39;, &#39;flags&#39;].</span>
<span class="sd">    These correspond to the minor frame time, minor frame count, major frame count,</span>
<span class="sd">    the list of packets, and flags returned by MAUDE respectively.</span>

<span class="sd">    This function raises an exception if the VCDU frames in maude_result are not contiguous, which</span>
<span class="sd">    can also happen if the frames are corrupted in some way.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    start : CxoTimeLike</span>
<span class="sd">        Start time for packets</span>
<span class="sd">    stop : CxoTimeLike</span>
<span class="sd">        Stop time for packets</span>
<span class="sd">    maude_result</span>
<span class="sd">        the result of calling maude.get_frames. Optional.</span>
<span class="sd">    **maude_kwargs</span>
<span class="sd">        keyword args passed to maude.get_frames()</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">    {&#39;flags&#39;: int, &#39;packets&#39;: [],</span>
<span class="sd">    &#39;TIME&#39;: np.array([]), &#39;MNF&#39;: np.array([]), &#39;MJF&#39;: np.array([])}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">date_start</span><span class="p">,</span> <span class="n">date_stop</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span>
    <span class="n">stop_pad</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span>  <span class="c1"># padding at the end in case of trailing partial ACA packets</span>

    <span class="c1"># get the frames and unpack front matter</span>
    <span class="k">if</span> <span class="n">maude_result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">frames</span> <span class="o">=</span> <span class="n">maude</span><span class="o">.</span><span class="n">get_frames</span><span class="p">(</span>
            <span class="n">start</span><span class="o">=</span><span class="n">date_start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">date_stop</span> <span class="o">+</span> <span class="n">stop_pad</span><span class="p">,</span> <span class="o">**</span><span class="n">maude_kwargs</span>
        <span class="p">)[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">frames</span> <span class="o">=</span> <span class="n">maude_result</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="n">frames</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">]</span>
    <span class="n">frames</span> <span class="o">=</span> <span class="n">frames</span><span class="p">[</span><span class="s2">&quot;frames&quot;</span><span class="p">]</span>

    <span class="c1"># ACA telemetry data is split into four frames. Each frame has a counter, and the first frame</span>
    <span class="c1"># in each group of four has a counter that is a multiple of 4. The following unpacks</span>
    <span class="c1"># the VCDU counter from the front matter of each frame.</span>
    <span class="c1"># The VCDU counter is stored in 24 bits, and struct.unpack does not have a 24-bit format code.</span>
    <span class="c1"># We therefore decom the bytes separately and combine them into a single integer using the</span>
    <span class="c1"># following weights:</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">vcdu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span> <span class="o">*</span> <span class="n">_unpack</span><span class="p">(</span><span class="s2">&quot;BBB&quot;</span><span class="p">,</span> <span class="n">frame</span><span class="p">[</span><span class="s2">&quot;bytes&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">]))</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># the following ensures that:</span>
    <span class="c1">#  - VCDU numbers are a strictly monotonic sequence</span>
    <span class="c1">#  - Frames come in packets of four. A missing frame would cause the packet to be dropped.</span>
    <span class="n">selected</span> <span class="o">=</span> <span class="n">filter_vcdu_jumps</span><span class="p">(</span><span class="n">vcdu</span><span class="p">)</span>
    <span class="n">vcdu</span> <span class="o">=</span> <span class="n">vcdu</span><span class="p">[</span><span class="n">selected</span><span class="p">]</span>
    <span class="n">frames</span> <span class="o">=</span> <span class="p">[</span><span class="n">frame</span> <span class="k">for</span> <span class="n">frame</span><span class="p">,</span> <span class="n">sel</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">frames</span><span class="p">,</span> <span class="n">selected</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">if</span> <span class="n">sel</span><span class="p">]</span>
    <span class="n">vcdu_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">frame</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">])</span>

    <span class="n">sub</span> <span class="o">=</span> <span class="n">vcdu</span> <span class="o">%</span> <span class="mi">4</span>  <span class="c1"># the minor frame index within each ACA update</span>

    <span class="n">major_counter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span>
        <span class="n">sub</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="p">)</span>  <span class="c1"># this number is monotonically increasing starting at 0</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">major_counter</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">major_counter</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="c1"># only unpack complete ACA frames in the original range:</span>
    <span class="n">aca_frame_entries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_all</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;flags&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;packets&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;TIME&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;MNF&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;MJF&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;VCDUCTR&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>
    <span class="n">aca_frame_entries</span><span class="p">[</span><span class="n">major_counter</span><span class="p">,</span> <span class="n">sub</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">vcdu_times</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">aca_frame_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_all</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">aca_frame_times</span><span class="p">[</span><span class="n">major_counter</span><span class="p">,</span> <span class="n">sub</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcdu_times</span>

    <span class="c1"># this will remove ACA records with at least one missing minor frame</span>
    <span class="n">select</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">aca_frame_times</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="o">*</span> <span class="p">(</span><span class="n">aca_frame_times</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">date_start</span><span class="o">.</span><span class="n">secs</span><span class="p">)</span>
        <span class="o">*</span> <span class="p">(</span><span class="n">aca_frame_times</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">date_stop</span><span class="o">.</span><span class="n">secs</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># assemble the 56 bit ACA minor records and times (time is not unpacked)</span>
    <span class="n">aca</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">aca_times</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">:</span>
        <span class="n">aca_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">])</span>
        <span class="n">aca</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">frame</span><span class="p">[</span><span class="s2">&quot;bytes&quot;</span><span class="p">][</span><span class="n">j</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">14</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">18</span><span class="p">,</span> <span class="mi">274</span><span class="p">,</span> <span class="mi">530</span><span class="p">,</span> <span class="mi">780</span><span class="p">]]))</span>

    <span class="c1"># combine them into 224 byte frames (it currently ensures all 224 bytes are there)</span>
    <span class="n">aca_packets</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">aca</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">])</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">aca_frame_entries</span><span class="p">[</span><span class="n">select</span><span class="p">]</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">aca_packets</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">224</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ACA packet is not 224 bytes long&quot;</span><span class="p">)</span>

    <span class="n">times</span> <span class="o">=</span> <span class="n">vcdu_times</span><span class="p">[</span><span class="n">aca_frame_entries</span><span class="p">[</span><span class="n">select</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
    <span class="n">vcdu_counter</span> <span class="o">=</span> <span class="n">vcdu</span><span class="p">[</span><span class="n">aca_frame_entries</span><span class="p">[</span><span class="n">select</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;flags&quot;</span><span class="p">:</span> <span class="n">flags</span><span class="p">,</span>
        <span class="s2">&quot;packets&quot;</span><span class="p">:</span> <span class="n">aca_packets</span><span class="p">,</span>
        <span class="s2">&quot;TIME&quot;</span><span class="p">:</span> <span class="n">times</span><span class="p">,</span>
        <span class="s2">&quot;MNF&quot;</span><span class="p">:</span> <span class="n">vcdu_counter</span> <span class="o">%</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">),</span>
        <span class="s2">&quot;MJF&quot;</span><span class="p">:</span> <span class="n">vcdu_counter</span> <span class="o">//</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">),</span>
        <span class="s2">&quot;VCDUCTR&quot;</span><span class="p">:</span> <span class="n">vcdu_counter</span><span class="p">,</span>
    <span class="p">}</span>


<div class="viewcode-block" id="ACA_PACKETS_DTYPE">
<a class="viewcode-back" href="../../api/chandra_aca/maude_decom/index.html#chandra_aca.maude_decom.ACA_PACKETS_DTYPE">[docs]</a>
<span class="n">ACA_PACKETS_DTYPE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;TIME&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;VCDUCTR&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;MJF&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;MNF&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;IMGNUM&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;COMMCNT&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;COMMPROG&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;GLBSTAT&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;IMGFUNC&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;IMGTYPE&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;IMGSCALE&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;IMGROW0&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;IMGCOL0&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;INTEG&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;BGDAVG&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;BGDRMS&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;TEMPCCD&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;TEMPHOUS&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;TEMPPRIM&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;TEMPSEC&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;BGDSTAT&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;HIGH_BGD&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;RAM_FAIL&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;ROM_FAIL&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;POWER_FAIL&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;CAL_FAIL&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;COMM_CHECKSUM_FAIL&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;RESET&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;SYNTAX_ERROR&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;COMMCNT_SYNTAX_ERROR&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;COMMCNT_CHECKSUM_FAIL&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;COMMPROG_REPEAT&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;IMGFID&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;IMGSTAT&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;SAT_PIXEL&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;DEF_PIXEL&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;QUAD_BOUND&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;COMMON_COL&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;MULTI_STAR&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;ION_RAD&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;IMGROW_A1&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;IMGCOL_A1&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;IMGROW0_8X8&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;IMGCOL0_8X8&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;END_INTEG_TIME&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;AAPIXTLM&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;U4&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;AABGDTYP&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;U4&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;IMG&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;f8&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">)),</span>
    <span class="p">]</span>
<span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_aca_packets_to_table</span><span class="p">(</span><span class="n">aca_packets</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Store ACA packets in a table.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    aca_packets</span>
<span class="sd">        list of dict</span>
<span class="sd">    dtype</span>
<span class="sd">        dtype to use in the resulting table. Optional.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    astropy.table.Table</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">copy</span>

    <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">ACA_PACKETS_DTYPE</span>

    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_all</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">aca_packets</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">names</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">aca_packet</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">aca_packets</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;IMG&quot;</span> <span class="ow">in</span> <span class="n">aca_packet</span><span class="p">:</span>
            <span class="n">img</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aca_packet</span><span class="p">[</span><span class="s2">&quot;IMG&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">aca_packet</span><span class="p">:</span>
                <span class="n">array</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">aca_packet</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">img</span><span class="p">:</span>
        <span class="n">table</span><span class="p">[</span><span class="s2">&quot;IMG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">aca_packet</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">aca_packets</span><span class="p">):</span>
            <span class="n">table</span><span class="p">[</span><span class="s2">&quot;IMG&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">aca_packet</span><span class="p">[</span><span class="s2">&quot;IMG&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span>
    <span class="k">return</span> <span class="n">table</span>


<span class="k">def</span> <span class="nf">get_aca_packets</span><span class="p">(</span>
    <span class="n">start</span><span class="p">,</span>
    <span class="n">stop</span><span class="p">,</span>
    <span class="n">level0</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">combine</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">adjust_time</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">calibrate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">blobs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">frames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">maude_kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetch VCDU 1025-byte frames, extract ACA packets, unpack them and store them in a table.</span>

<span class="sd">    Incomplete ACA packets (if there is a minor frame missing) can be combined or not into records</span>
<span class="sd">    with complete ACA telemetry. Compare these to calls to the function:</span>

<span class="sd">            &gt;&gt;&gt; from chandra_aca import maude_decom</span>
<span class="sd">            &gt;&gt;&gt; img = maude_decom.get_aca_packets(684089000, 684089016, combine=True)</span>
<span class="sd">            &gt;&gt;&gt; img = img[img[&#39;IMGNUM&#39;] == 0]</span>
<span class="sd">            &gt;&gt;&gt; img[&#39;TIME&#39;, &#39;MJF&#39;, &#39;MNF&#39;, &#39;COMMCNT&#39;, &#39;GLBSTAT&#39;, &#39;IMGTYPE&#39;, &#39;IMGROW0&#39;, &#39;IMGCOL0&#39;,</span>
<span class="sd">            &gt;&gt;&gt;     &#39;TEMPCCD&#39;, &#39;TEMPHOUS&#39;]</span>
<span class="sd">            &lt;Table masked=True length=4&gt;</span>
<span class="sd">                 TIME      MJF    MNF   COMMCNT GLBSTAT IMGTYPE IMGROW0 IMGCOL0 TEMPCCD TEMPHOUS</span>
<span class="sd">               float64    uint32 uint32  uint8   uint8   uint8   int16   int16   int16   int16</span>
<span class="sd">            ------------- ------ ------ ------- ------- ------- ------- ------- ------- --------</span>
<span class="sd">            684089001.869  78006     32       0       0       4     469    -332     -20       83</span>
<span class="sd">            684089005.969  78006     48       0       0       4     469    -332     -20       83</span>
<span class="sd">            684089010.069  78006     64       0       0       4     469    -332     -20       83</span>
<span class="sd">            684089014.169  78006     80       0       0       4     469    -332     -20       83</span>

<span class="sd">    Using combined=False, results in records with incomplete images. In this case, data can be</span>
<span class="sd">    missing from some records. For example, with 8X8 images, IMGROW0 and IMGCOL0 are present in the</span>
<span class="sd">    first ACA packet (image type 4) while the temperature is present in the second (image type 5):</span>

<span class="sd">        &gt;&gt;&gt; from chandra_aca import maude_decom</span>
<span class="sd">        &gt;&gt;&gt; img = maude_decom.get_aca_packets(684089000, 684089016, combine=False)</span>
<span class="sd">        &gt;&gt;&gt; img = img[img[&#39;IMGNUM&#39;] == 0]</span>
<span class="sd">        &gt;&gt;&gt; img[&#39;TIME&#39;, &#39;MJF&#39;, &#39;MNF&#39;, &#39;COMMCNT&#39;, &#39;GLBSTAT&#39;, &#39;IMGTYPE&#39;, &#39;IMGROW0&#39;, &#39;IMGCOL0&#39;,</span>
<span class="sd">        &gt;&gt;&gt;     &#39;TEMPCCD&#39;, &#39;TEMPHOUS&#39;]</span>
<span class="sd">            &lt;Table masked=True length=15&gt;</span>
<span class="sd">                 TIME      MJF    MNF   COMMCNT GLBSTAT IMGTYPE IMGROW0 IMGCOL0 TEMPCCD TEMPHOUS</span>
<span class="sd">               float64    uint32 uint32  uint8   uint8   uint8   int16   int16   int16   int16</span>
<span class="sd">            ------------- ------ ------ ------- ------- ------- ------- ------- ------- --------</span>
<span class="sd">            684089000.844  78006     28       0       0       7      --      --      --       --</span>
<span class="sd">            684089001.869  78006     32       0       0       4     469    -332      --       --</span>
<span class="sd">            684089002.894  78006     36       0       0       5      --      --     -20       83</span>
<span class="sd">            684089003.919  78006     40       0       0       6      --      --      --       --</span>
<span class="sd">            684089004.944  78006     44       0       0       7      --      --      --       --</span>
<span class="sd">            684089005.969  78006     48       0       0       4     469    -332      --       --</span>
<span class="sd">            684089006.994  78006     52       0       0       5      --      --     -20       83</span>
<span class="sd">            684089008.019  78006     56       0       0       6      --      --      --       --</span>
<span class="sd">            684089009.044  78006     60       0       0       7      --      --      --       --</span>
<span class="sd">            684089010.069  78006     64       0       0       4     469    -332      --       --</span>
<span class="sd">            684089011.094  78006     68       0       0       5      --      --     -20       83</span>
<span class="sd">            684089012.119  78006     72       0       0       6      --      --      --       --</span>
<span class="sd">            684089013.144  78006     76       0       0       7      --      --      --       --</span>
<span class="sd">            684089014.169  78006     80       0       0       4     469    -332      --       --</span>
<span class="sd">            684089015.194  78006     84       0       0       5      --      --     -20       83</span>

<span class="sd">        &gt;&gt;&gt; img[&#39;IMG&#39;].data[1]</span>
<span class="sd">        masked_BaseColumn(data =</span>
<span class="sd">         [[60.0 97.0 70.0 120.0 74.0 111.0 103.0 108.0]</span>
<span class="sd">         [67.0 90.0 144.0 96.0 88.0 306.0 82.0 67.0]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]],</span>
<span class="sd">                          mask =</span>
<span class="sd">         [[False False False False False False False False]</span>
<span class="sd">         [False False False False False False False False]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]],</span>
<span class="sd">                    fill_value = 1e+20)</span>

<span class="sd">        &gt;&gt;&gt; img[&#39;IMG&#39;].data[2]</span>
<span class="sd">        masked_BaseColumn(data =</span>
<span class="sd">         [[-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [76.0 81.0 160.0 486.0 449.0 215.0 88.0 156.0]</span>
<span class="sd">         [68.0 91.0 539.0 483.0 619.0 412.0 105.0 77.0]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]],</span>
<span class="sd">                          mask =</span>
<span class="sd">         [[ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [False False False False False False False False]</span>
<span class="sd">         [False False False False False False False False]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]],</span>
<span class="sd">                    fill_value = 1e+20)</span>

<span class="sd">        &gt;&gt;&gt; img[&#39;IMG&#39;].data[3]</span>
<span class="sd">        masked_BaseColumn(data =</span>
<span class="sd">         [[-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [86.0 101.0 408.0 344.0 556.0 343.0 122.0 67.0]</span>
<span class="sd">         [196.0 195.0 114.0 321.0 386.0 115.0 69.0 189.0]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]],</span>
<span class="sd">                          mask =</span>
<span class="sd">         [[ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [False False False False False False False False]</span>
<span class="sd">         [False False False False False False False False]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]],</span>
<span class="sd">                    fill_value = 1e+20)</span>

<span class="sd">        &gt;&gt;&gt; img[&#39;IMG&#39;].data[4]</span>
<span class="sd">        Out[10]:</span>
<span class="sd">        masked_BaseColumn(data =</span>
<span class="sd">         [[-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [-- -- -- -- -- -- -- --]</span>
<span class="sd">         [67.0 61.0 67.0 176.0 99.0 72.0 79.0 88.0]</span>
<span class="sd">         [70.0 62.0 101.0 149.0 163.0 89.0 60.0 76.0]],</span>
<span class="sd">                          mask =</span>
<span class="sd">         [[ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [ True  True  True  True  True  True  True  True]</span>
<span class="sd">         [False False False False False False False False]</span>
<span class="sd">         [False False False False False False False False]],</span>
<span class="sd">                    fill_value = 1e+20)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    start : CxoTimeLike</span>
<span class="sd">        Start time for the ACA packets</span>
<span class="sd">    stop : CxoTimeLike</span>
<span class="sd">        Stop time for the ACA packets</span>
<span class="sd">    level0 : bool.</span>
<span class="sd">        Implies combine=True, adjust_time=True, calibrate=True</span>
<span class="sd">    combine : bool.</span>
<span class="sd">        If True, ACA subimages are combined to form a full image (depending on size),</span>
<span class="sd">        If False, ACA subimages are not combined, resulting in multiple rows for 6x6 and 8x8 images.</span>
<span class="sd">    adjust_time : bool</span>
<span class="sd">        If True, TIME is at the middle of the integration window.</span>
<span class="sd">        If False, TIME is the VCDU time in telemetry of the packet frame (combine=False)</span>
<span class="sd">        or the VCDU time of the first sub-image of the combined image (combine=True).</span>
<span class="sd">    calibrate : bool</span>
<span class="sd">        If True, pixel values will be &#39;value * imgscale / 32 - 50&#39; and temperature values will</span>
<span class="sd">        be: 0.4 * value + 273.15</span>
<span class="sd">    blobs : bool or dict</span>
<span class="sd">        If set, data is assembled from MAUDE blobs. If it is a dictionary, it must be the</span>
<span class="sd">        output of maude.get_blobs ({&#39;blobs&#39;: ... }).</span>
<span class="sd">    frames : bool or dict</span>
<span class="sd">        If set, data is assembled from MAUDE frames. If it is a dictionary, it must be the</span>
<span class="sd">        output of maude.get_frames ({&#39;data&#39;: ... }).</span>
<span class="sd">    dtype : np.dtype. Optional.</span>
<span class="sd">        the dtype to use when creating the resulting table. This is useful to add columns</span>
<span class="sd">        including MSIDs that are present in blobs. If used with frames, most probably you will get</span>
<span class="sd">        and empty column. This option is intended to augment the default dtype. If a more</span>
<span class="sd">        restrictive dtype is used, a KeyError can be raised.</span>
<span class="sd">    **maude_kwargs</span>
<span class="sd">        Keyword args passed to maude</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    astropy.table.Table</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">blobs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">frames</span><span class="p">:</span>
        <span class="n">frames</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">blobs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">frames</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">frames</span> <span class="ow">and</span> <span class="n">blobs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Specify one and only one of &#39;blobs&#39; or &#39;frames&#39;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">level0</span><span class="p">:</span>
        <span class="n">adjust_time</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">combine</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">calibrate</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">date_start</span><span class="p">,</span> <span class="n">date_stop</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">date_stop</span> <span class="o">-</span> <span class="n">date_start</span> <span class="o">&gt;</span> <span class="n">MAUDE_SINGLE_FETCH_LIMIT</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Requested </span><span class="si">{</span><span class="p">(</span><span class="n">date_stop</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">date_start</span><span class="p">)</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="s1">&#39;hr&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> hr of telemetry. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Maximum allowed is </span><span class="si">{</span><span class="n">MAUDE_SINGLE_FETCH_LIMIT</span><span class="si">}</span><span class="s2"> at a time &quot;</span>
            <span class="s2">&quot;(see MAUDE_SINGLE_FETCH_LIMIT).&quot;</span>
        <span class="p">)</span>

    <span class="n">stop_pad</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span>
    <span class="k">if</span> <span class="n">adjust_time</span><span class="p">:</span>
        <span class="n">stop_pad</span> <span class="o">+=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span>  <span class="c1"># time will get shifted...</span>
    <span class="k">if</span> <span class="n">combine</span><span class="p">:</span>
        <span class="n">stop_pad</span> <span class="o">+=</span> <span class="mf">3.08</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span>  <span class="c1"># there can be trailing frames</span>

    <span class="k">if</span> <span class="n">frames</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">date_stop</span> <span class="o">-</span> <span class="n">date_start</span><span class="p">)</span><span class="o">.</span><span class="n">sec</span> <span class="o">/</span> <span class="mi">300</span><span class="p">))</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">date_stop</span> <span class="o">-</span> <span class="n">date_start</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span>
        <span class="n">batches</span> <span class="o">=</span> <span class="p">[(</span><span class="n">date_start</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">dt</span><span class="p">,</span> <span class="n">date_start</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
        <span class="n">aca_packets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="ow">in</span> <span class="n">batches</span><span class="p">:</span>
            <span class="n">maude_result</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">frames</span> <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span> <span class="ow">and</span> <span class="s2">&quot;data&quot;</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="n">raw_aca_packets</span> <span class="o">=</span> <span class="n">get_raw_aca_packets</span><span class="p">(</span>
                <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">+</span> <span class="n">stop_pad</span><span class="p">,</span> <span class="n">maude_result</span><span class="o">=</span><span class="n">maude_result</span><span class="p">,</span> <span class="o">**</span><span class="n">maude_kwargs</span>
            <span class="p">)</span>
            <span class="n">packets</span> <span class="o">=</span> <span class="n">_get_aca_packets</span><span class="p">(</span>
                <span class="n">raw_aca_packets</span><span class="p">,</span>
                <span class="n">t1</span><span class="p">,</span>
                <span class="n">t2</span><span class="p">,</span>
                <span class="n">combine</span><span class="o">=</span><span class="n">combine</span><span class="p">,</span>
                <span class="n">adjust_time</span><span class="o">=</span><span class="n">adjust_time</span><span class="p">,</span>
                <span class="n">calibrate</span><span class="o">=</span><span class="n">calibrate</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">aca_packets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">packets</span><span class="p">)</span>
        <span class="n">aca_data</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">(</span><span class="n">aca_packets</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">maude_result</span> <span class="o">=</span> <span class="n">blobs</span> <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">blobs</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span> <span class="ow">and</span> <span class="s2">&quot;blobs&quot;</span> <span class="ow">in</span> <span class="n">blobs</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">merged_blobs</span> <span class="o">=</span> <span class="n">get_raw_aca_blobs</span><span class="p">(</span>
            <span class="n">date_start</span><span class="p">,</span> <span class="n">date_stop</span> <span class="o">+</span> <span class="n">stop_pad</span><span class="p">,</span> <span class="n">maude_result</span><span class="o">=</span><span class="n">maude_result</span><span class="p">,</span> <span class="o">**</span><span class="n">maude_kwargs</span>
        <span class="p">)[</span><span class="s2">&quot;blobs&quot;</span><span class="p">]</span>
        <span class="n">aca_packets</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">blob_to_aca_image_dict</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">merged_blobs</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">aca_data</span> <span class="o">=</span> <span class="n">_get_aca_packets</span><span class="p">(</span>
            <span class="n">aca_packets</span><span class="p">,</span>
            <span class="n">date_start</span><span class="p">,</span>
            <span class="n">date_stop</span> <span class="o">+</span> <span class="n">stop_pad</span><span class="p">,</span>
            <span class="n">combine</span><span class="o">=</span><span class="n">combine</span><span class="p">,</span>
            <span class="n">adjust_time</span><span class="o">=</span><span class="n">adjust_time</span><span class="p">,</span>
            <span class="n">calibrate</span><span class="o">=</span><span class="n">calibrate</span><span class="p">,</span>
            <span class="n">blobs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">aca_data</span> <span class="o">=</span> <span class="n">aca_data</span><span class="p">[(</span><span class="n">aca_data</span><span class="p">[</span><span class="s2">&quot;TIME&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">aca_data</span><span class="p">[</span><span class="s2">&quot;TIME&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">stop</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">aca_data</span>


<span class="k">def</span> <span class="nf">_get_aca_packets</span><span class="p">(</span>
    <span class="n">aca_packets</span><span class="p">,</span>
    <span class="n">start</span><span class="p">,</span>
    <span class="n">stop</span><span class="p">,</span>
    <span class="n">combine</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">adjust_time</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">calibrate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">blobs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a convenience function that splits get_aca_packets for testing without MAUDE.</span>

<span class="sd">    Same arguments as get_aca_packets plus aca_packets, the raw ACA 225-byte packets.</span>

<span class="sd">    NOTE: This function has a side effect. It adds decom_packets to the input aca_packets.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span>  <span class="c1"># ensure input is proper date</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">blobs</span><span class="p">:</span>
        <span class="c1"># this adds TIME, MJF, MNF and VCDUCTR, which is already there in the blob dictionary</span>
        <span class="n">aca_packets</span><span class="p">[</span><span class="s2">&quot;decom_packets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">unpack_aca_telemetry</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">aca_packets</span><span class="p">[</span><span class="s2">&quot;packets&quot;</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aca_packets</span><span class="p">[</span><span class="s2">&quot;decom_packets&quot;</span><span class="p">])):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
                <span class="n">aca_packets</span><span class="p">[</span><span class="s2">&quot;decom_packets&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;TIME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aca_packets</span><span class="p">[</span><span class="s2">&quot;TIME&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">aca_packets</span><span class="p">[</span><span class="s2">&quot;decom_packets&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;MJF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aca_packets</span><span class="p">[</span><span class="s2">&quot;MJF&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">aca_packets</span><span class="p">[</span><span class="s2">&quot;decom_packets&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;MNF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aca_packets</span><span class="p">[</span><span class="s2">&quot;MNF&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;VCDUCTR&quot;</span> <span class="ow">in</span> <span class="n">aca_packets</span><span class="p">:</span>
                    <span class="n">aca_packets</span><span class="p">[</span><span class="s2">&quot;decom_packets&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;VCDUCTR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aca_packets</span><span class="p">[</span>
                        <span class="s2">&quot;VCDUCTR&quot;</span>
                    <span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">aca_packets</span><span class="p">[</span><span class="s2">&quot;decom_packets&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;IMGNUM&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>

        <span class="n">aca_packets</span> <span class="o">=</span> <span class="p">[[</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">aca_packets</span><span class="p">[</span><span class="s2">&quot;decom_packets&quot;</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">combine</span><span class="p">:</span>
        <span class="n">aca_packets</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">_combine_aca_packets</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">_group_packets</span><span class="p">(</span><span class="n">p</span><span class="p">)]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">aca_packets</span><span class="p">],</span>
            <span class="p">[],</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">aca_packets</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">_combine_aca_packets</span><span class="p">([</span><span class="n">row</span><span class="p">])</span> <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">aca_packets</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">slot</span>
        <span class="p">]</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">_aca_packets_to_table</span><span class="p">(</span><span class="n">aca_packets</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">calibrate</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;TEMPCCD&quot;</span><span class="p">,</span> <span class="s2">&quot;TEMPSEC&quot;</span><span class="p">,</span> <span class="s2">&quot;TEMPHOUS&quot;</span><span class="p">,</span> <span class="s2">&quot;TEMPPRIM&quot;</span><span class="p">]:</span>
            <span class="n">table</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="n">table</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">+</span> <span class="mf">273.15</span>

    <span class="c1"># IMGROW0/COL0 are actually the row/col of pixel A1, so we just copy them</span>
    <span class="n">table</span><span class="p">[</span><span class="s2">&quot;IMGROW_A1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;IMGROW0&quot;</span><span class="p">]</span>
    <span class="n">table</span><span class="p">[</span><span class="s2">&quot;IMGCOL_A1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;IMGCOL0&quot;</span><span class="p">]</span>

    <span class="c1"># if the image is embedded in an 8x8 image, row/col of the 8x8 shifts for sizes 4x4 and 6x6</span>
    <span class="n">table</span><span class="p">[</span><span class="s2">&quot;IMGROW0_8X8&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;IMGROW_A1&quot;</span><span class="p">]</span>
    <span class="n">table</span><span class="p">[</span><span class="s2">&quot;IMGCOL0_8X8&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;IMGCOL_A1&quot;</span><span class="p">]</span>
    <span class="n">table</span><span class="p">[</span><span class="s2">&quot;IMGROW0_8X8&quot;</span><span class="p">][</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;IMGTYPE&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">2</span>
    <span class="n">table</span><span class="p">[</span><span class="s2">&quot;IMGCOL0_8X8&quot;</span><span class="p">][</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;IMGTYPE&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">2</span>

    <span class="c1"># and the usual row/col needs to be adjusted only for 6x6 images</span>
    <span class="n">table</span><span class="p">[</span><span class="s2">&quot;IMGROW0&quot;</span><span class="p">][</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;IMGTYPE&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="n">table</span><span class="p">[</span><span class="s2">&quot;IMGCOL0&quot;</span><span class="p">][</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;IMGTYPE&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="n">table</span><span class="p">[</span><span class="s2">&quot;IMGROW0&quot;</span><span class="p">][</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;IMGTYPE&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="n">table</span><span class="p">[</span><span class="s2">&quot;IMGCOL0&quot;</span><span class="p">][</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;IMGTYPE&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="n">table</span><span class="p">[</span><span class="s2">&quot;INTEG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;INTEG&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.016</span>

    <span class="c1"># the time of an image is the time of its first subimage IMG_TIME, which is set 1.025 seconds</span>
    <span class="c1"># after the end of integration.</span>
    <span class="c1"># d_vcductr is the number of VCDU frames since the first subimage.</span>
    <span class="n">d_vcductr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">table</span><span class="p">[</span><span class="s2">&quot;IMGTYPE&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">table</span><span class="p">[</span><span class="s2">&quot;IMGTYPE&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;IMGTYPE&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">table</span><span class="p">[</span><span class="s2">&quot;IMG_VCDUCTR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;VCDUCTR&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">d_vcductr</span><span class="p">)</span> <span class="o">%</span> <span class="n">MAX_VCDU</span>
    <span class="n">img_time</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;TIME&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.025</span> <span class="o">*</span> <span class="n">d_vcductr</span>
    <span class="n">table</span><span class="p">[</span><span class="s2">&quot;END_INTEG_TIME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_time</span> <span class="o">-</span> <span class="mf">1.025</span>

    <span class="k">if</span> <span class="n">adjust_time</span><span class="p">:</span>
        <span class="c1"># After this adjustment, TIME corresponds to the center of integration interval and</span>
        <span class="c1"># END_INTEG_TIME to the end:</span>
        <span class="c1">#     END_INTEG_TIME == TIME + INTEG / 2.0</span>
        <span class="c1"># See also https://cxc.harvard.edu/mta/ASPECT/Docs/aca_l0_icd.pdf section D.2.4.</span>
        <span class="n">table</span><span class="p">[</span><span class="s2">&quot;TIME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;END_INTEG_TIME&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;INTEG&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="k">if</span> <span class="n">calibrate</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;IMG&quot;</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
            <span class="n">table</span><span class="p">[</span><span class="s2">&quot;IMG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">table</span><span class="p">[</span><span class="s2">&quot;IMG&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;IMGSCALE&quot;</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">/</span> <span class="mi">32</span> <span class="o">-</span> <span class="mi">50</span>
            <span class="p">)</span>

    <span class="n">table</span> <span class="o">=</span> <span class="n">table</span><span class="p">[(</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;TIME&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="o">.</span><span class="n">secs</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;TIME&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">stop</span><span class="o">.</span><span class="n">secs</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">dtype</span><span class="p">:</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">table</span>


<span class="k">def</span> <span class="nf">get_aca_images</span><span class="p">(</span><span class="n">start</span><span class="p">:</span> <span class="n">CxoTimeLike</span><span class="p">,</span> <span class="n">stop</span><span class="p">:</span> <span class="n">CxoTimeLike</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetch ACA image telemetry</span>

<span class="sd">    Fetch ACA image telemetry from MAUDE and return it as an astropy Table. With the</span>
<span class="sd">    default settings and no additional kwargs, this calls `get_aca_packets()` in a</span>
<span class="sd">    configuration that uses MAUDE frames, combines image data, and sets the TIME</span>
<span class="sd">    associated with each image to the midpoint of the integration time during which that</span>
<span class="sd">    pixel data was collected (matches CXC L0 times). See `get_aca_packets()`.</span>

<span class="sd">    The &#39;IMG&#39; column is always Nx8x8 and masked, where the mask is a per-pixel mask that</span>
<span class="sd">    indicates missing data for 4x4 or 6x6 images. The units of &#39;IMG&#39; are DN.</span>

<span class="sd">    For queries including 4x4 data, the &#39;BGDRMS&#39;, &#39;TEMPCCD&#39;, &#39;TEMPHOUS&#39;, &#39;TEMPPRIM&#39;,</span>
<span class="sd">    &#39;TEMPSEC&#39;, and &#39;BGDSTAT&#39; columns will be masked since they are not present in the</span>
<span class="sd">    4x4 image data.</span>

<span class="sd">    There are three different specifiers of the image row/col location:</span>

<span class="sd">    - IMGROW0_8x8/IMGCOL0_8x8: the row/col of the lower-left pixel of the 8x8 masked</span>
<span class="sd">      image. This is generally the most useful.</span>
<span class="sd">    - IMGROW0/IMGCOL0: the row/col of the lower-left pixel of the actual 4x4, 6x6, or</span>
<span class="sd">      8x8 image data. For 6x6 this corresponds to the mouse-bitten corner pixel.</span>
<span class="sd">    - IMGROW_A1/IMGCOL_A1: the row/col of the A1 pixel in telemetry (see ACA EQ-spec).</span>

<span class="sd">    The full list of columns is::</span>

<span class="sd">               name          dtype  unit</span>
<span class="sd">      --------------------- ------- -----------</span>
<span class="sd">                       TIME float64 CXC seconds</span>
<span class="sd">                    VCDUCTR  uint32</span>
<span class="sd">                        MJF  uint32</span>
<span class="sd">                        MNF  uint32</span>
<span class="sd">                     IMGNUM  uint32</span>
<span class="sd">                    COMMCNT   uint8</span>
<span class="sd">                   COMMPROG   uint8</span>
<span class="sd">                    GLBSTAT   uint8</span>
<span class="sd">                    IMGFUNC  uint32</span>
<span class="sd">                    IMGTYPE   uint8</span>
<span class="sd">                   IMGSCALE  uint16</span>
<span class="sd">                    IMGROW0   int16</span>
<span class="sd">                    IMGCOL0   int16</span>
<span class="sd">                      INTEG float64 s</span>
<span class="sd">                     BGDAVG  uint16 DN</span>
<span class="sd">                     BGDRMS  uint16 DN</span>
<span class="sd">                    TEMPCCD float32 degC</span>
<span class="sd">                   TEMPHOUS float32 degC</span>
<span class="sd">                   TEMPPRIM float32 degC</span>
<span class="sd">                    TEMPSEC float32 degC</span>
<span class="sd">                    BGDSTAT   uint8</span>
<span class="sd">                   HIGH_BGD    bool</span>
<span class="sd">                   RAM_FAIL    bool</span>
<span class="sd">                   ROM_FAIL    bool</span>
<span class="sd">                 POWER_FAIL    bool</span>
<span class="sd">                   CAL_FAIL    bool</span>
<span class="sd">         COMM_CHECKSUM_FAIL    bool</span>
<span class="sd">                      RESET    bool</span>
<span class="sd">               SYNTAX_ERROR    bool</span>
<span class="sd">       COMMCNT_SYNTAX_ERROR    bool</span>
<span class="sd">      COMMCNT_CHECKSUM_FAIL    bool</span>
<span class="sd">            COMMPROG_REPEAT   uint8</span>
<span class="sd">                     IMGFID    bool</span>
<span class="sd">                    IMGSTAT   uint8</span>
<span class="sd">                  SAT_PIXEL    bool</span>
<span class="sd">                  DEF_PIXEL    bool</span>
<span class="sd">                 QUAD_BOUND    bool</span>
<span class="sd">                 COMMON_COL    bool</span>
<span class="sd">                 MULTI_STAR    bool</span>
<span class="sd">                    ION_RAD    bool</span>
<span class="sd">                  IMGROW_A1   int16</span>
<span class="sd">                  IMGCOL_A1   int16</span>
<span class="sd">                IMGROW0_8X8   int16</span>
<span class="sd">                IMGCOL0_8X8   int16</span>
<span class="sd">             END_INTEG_TIME float64</span>
<span class="sd">                   AAPIXTLM    str4</span>
<span class="sd">                   AABGDTYP    str4</span>
<span class="sd">                        IMG float64 DN</span>
<span class="sd">                IMG_VCDUCTR   int64</span>

<span class="sd">    This function can be used to fetch up to 5 days of ACA image telemetry at a time.</span>
<span class="sd">    If more is needed, you can set the module variable ``MAUDE_FETCH_LIMIT`` to a larger</span>
<span class="sd">    value. Internally, this function will fetch the data in intervals of</span>
<span class="sd">    ``MAUDE_SINGLE_FETCH_LIMIT``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    start</span>
<span class="sd">        timestamp, CxoTimeLike</span>
<span class="sd">    stop</span>
<span class="sd">        timestamp, CxoTimeLike.  stop - start cannot be greater than MAUDE_FETCH_LIMIT</span>
<span class="sd">    kwargs</span>
<span class="sd">        keyword args passed to get_aca_packets</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    astropy.table.Table</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># This is strictly for testing, hence undocumented.</span>
    <span class="n">set_times_metadata</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;set_times_metadata&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAUDE_FETCH_LIMIT</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;stop - start cannot be greater than </span><span class="si">{</span><span class="n">MAUDE_FETCH_LIMIT</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="s2">&quot;Set module variable MAUDE_FETCH_LIMIT if needed.&quot;</span>
        <span class="p">)</span>
    <span class="n">maude_fetch_times</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step_max</span><span class="o">=</span><span class="n">MAUDE_SINGLE_FETCH_LIMIT</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span>
    <span class="p">)</span>
    <span class="n">packet_stack</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">get_aca_packets</span><span class="p">(</span>
            <span class="n">start</span><span class="o">=</span><span class="n">istart</span><span class="p">,</span>
            <span class="n">stop</span><span class="o">=</span><span class="n">istop</span><span class="p">,</span>
            <span class="n">level0</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">istart</span><span class="p">,</span> <span class="n">istop</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">pairwise</span><span class="p">(</span><span class="n">maude_fetch_times</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">(</span><span class="n">packet_stack</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">set_times_metadata</span><span class="p">:</span>
        <span class="n">out</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;times&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">maude_fetch_times</span>

    <span class="c1"># Remove mask from columns where no values are masked. IMG is excepted because</span>
    <span class="c1"># the mask reflects the presence of 4x4 or 6x6 images, not entirely missing data</span>
    <span class="c1"># per row.</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">itercols</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span> <span class="ow">and</span> <span class="n">col</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;IMG&quot;</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span>

    <span class="k">return</span> <span class="n">out</span>


<span class="c1">######################</span>
<span class="c1"># blob-based functions</span>
<span class="c1">######################</span>


<span class="k">def</span> <span class="nf">get_raw_aca_blobs</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">maude_result</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">maude_kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetch MAUDE blobs and group them according to the underlying 225-byte ACA packets.</span>

<span class="sd">    If the first minor frame in a group of four ACA packets is within (start, stop),</span>
<span class="sd">    the three following minor frames are included if present.</span>

<span class="sd">    Returns a dictionary with keys [&#39;TIME&#39;, &#39;MNF&#39;, &#39;MJF&#39;, &#39;packets&#39;, &#39;flags&#39;].</span>
<span class="sd">    These correspond to the minor frame time, minor frame count, major frame count,</span>
<span class="sd">    the list of packets, and flags returned by MAUDE respectively.</span>

<span class="sd">    This is to blobs what `get_raw_aca_packets` is to frames.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    start : CxoTimeLike</span>
<span class="sd">        Start time for the ACA blobs</span>
<span class="sd">    stop : CxoTimeLike</span>
<span class="sd">        Stop time for the ACA blobs</span>
<span class="sd">    maude_result</span>
<span class="sd">        the result of calling maude.get_blobs. Optional.</span>
<span class="sd">    **maude_kwargs</span>
<span class="sd">        keyword args passed to maude.get_frames()</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">    {&#39;blobs&#39;: [], &#39;names&#39;: np.array([]), &#39;types&#39;: np.array([])}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">date_start</span><span class="p">,</span> <span class="n">date_stop</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span>

    <span class="n">stop_pad</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span>  <span class="c1"># padding at the end in case of trailing partial ACA packets</span>

    <span class="k">if</span> <span class="n">maude_result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">maude_blobs</span> <span class="o">=</span> <span class="n">maude</span><span class="o">.</span><span class="n">get_blobs</span><span class="p">(</span>
            <span class="n">start</span><span class="o">=</span><span class="n">date_start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">date_stop</span> <span class="o">+</span> <span class="n">stop_pad</span><span class="p">,</span> <span class="o">**</span><span class="n">maude_kwargs</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">maude_blobs</span> <span class="o">=</span> <span class="n">maude_result</span>

    <span class="n">aca_block_start</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ACA_SLOT_MSID_LIST</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="s2">&quot;sizes&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">b</span><span class="p">[</span><span class="s2">&quot;values&quot;</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">maude_blobs</span><span class="p">[</span><span class="s2">&quot;blobs&quot;</span><span class="p">]</span>
    <span class="p">]</span>

    <span class="n">names</span> <span class="o">=</span> <span class="n">maude_blobs</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">types</span> <span class="o">=</span> <span class="n">maude_blobs</span><span class="p">[</span><span class="s2">&quot;types&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">aca_block_start</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;blobs&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;names&quot;</span><span class="p">:</span> <span class="n">names</span><span class="p">,</span>
            <span class="s2">&quot;types&quot;</span><span class="p">:</span> <span class="n">types</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="n">blobs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">maude_blobs</span><span class="p">[</span><span class="s2">&quot;blobs&quot;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">aca_block_start</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="p">:])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">blobs</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">blobs</span> <span class="o">=</span> <span class="n">blobs</span><span class="p">[:</span> <span class="o">-</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">blobs</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">blobs</span><span class="p">:</span>
        <span class="n">b</span><span class="p">[</span><span class="s2">&quot;values&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]:</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">b</span><span class="p">[</span><span class="s2">&quot;values&quot;</span><span class="p">]}</span>

    <span class="n">merged_blobs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">blobs</span><span class="p">),</span> <span class="mi">4</span><span class="p">):</span>
        <span class="n">b</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">blobs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;time&quot;</span><span class="p">]}</span>
        <span class="c1"># blobs are merged in reverse order so the frame counters are the one in the first blob.</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">b</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">blobs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">][</span><span class="s2">&quot;values&quot;</span><span class="p">])</span>
        <span class="n">merged_blobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;blobs&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">merged_blobs</span> <span class="k">if</span> <span class="n">b</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">date_stop</span><span class="o">.</span><span class="n">secs</span><span class="p">],</span>
        <span class="s2">&quot;names&quot;</span><span class="p">:</span> <span class="n">names</span><span class="p">,</span>
        <span class="s2">&quot;types&quot;</span><span class="p">:</span> <span class="n">types</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">blob_to_aca_image_dict</span><span class="p">(</span><span class="n">blob</span><span class="p">,</span> <span class="n">imgnum</span><span class="p">,</span> <span class="n">pea</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assemble ACA image MSIDs from a blob into a dictionary.</span>

<span class="sd">    This does to blobs what unpack_aca_telemetry does to frames, but for a single image.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    blob</span>

<span class="sd">    imgnum</span>

<span class="sd">    pea</span>


<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">global_msids</span> <span class="o">=</span> <span class="n">ACA_MSID_LIST</span><span class="p">[</span><span class="n">pea</span><span class="p">]</span>
    <span class="n">slot_msids</span> <span class="o">=</span> <span class="n">ACA_SLOT_MSID_LIST</span><span class="p">[</span><span class="n">pea</span><span class="p">][</span><span class="n">imgnum</span><span class="p">]</span>
    <span class="n">glbstat_bits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unpackbits</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="n">global_msids</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
    <span class="n">comm_count_bits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unpackbits</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="n">global_msids</span><span class="p">[</span><span class="s2">&quot;cmd_count&quot;</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">comm_prog_bits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unpackbits</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="n">global_msids</span><span class="p">[</span><span class="s2">&quot;cmd_progress&quot;</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;TIME&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;MJF&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="s2">&quot;CVCMJCTR&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;MNF&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="s2">&quot;CVCMNCTR&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;VCDUCTR&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="s2">&quot;CVCDUCTR&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;IMGNUM&quot;</span><span class="p">:</span> <span class="n">imgnum</span><span class="p">,</span>
        <span class="s2">&quot;IMGTYPE&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="n">slot_msids</span><span class="p">[</span><span class="s2">&quot;sizes&quot;</span><span class="p">]]),</span>
        <span class="c1"># &#39;IMGFID&#39;: &#39;1&#39; == blob[slot_msids[&#39;fiducial_flag&#39;]],</span>
        <span class="c1"># &#39;IMGNUM&#39;: imgnum,</span>
        <span class="c1"># &#39;IMGFUNC&#39;: int(blob[slot_msids[&#39;image_function&#39;]]),</span>
        <span class="c1"># &#39;IMGSTAT&#39;: int(blob[slot_msids[&#39;image_status&#39;]]),</span>
        <span class="s2">&quot;pixels&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="n">pixel</span><span class="p">])</span> <span class="k">for</span> <span class="n">pixel</span> <span class="ow">in</span> <span class="n">slot_msids</span><span class="p">[</span><span class="s2">&quot;pixels&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">pixel</span> <span class="ow">in</span> <span class="n">blob</span><span class="p">]</span>
        <span class="p">),</span>
        <span class="s2">&quot;AAPIXTLM&quot;</span><span class="p">:</span> <span class="n">blob</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">global_msids</span><span class="p">[</span><span class="s2">&quot;pixel_telemetry_type&quot;</span><span class="p">],</span> <span class="s2">&quot;ORIG&quot;</span><span class="p">),</span>
        <span class="s2">&quot;AABGDTYP&quot;</span><span class="p">:</span> <span class="n">blob</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">global_msids</span><span class="p">[</span><span class="s2">&quot;dynamic_background_type&quot;</span><span class="p">],</span> <span class="s2">&quot;FLAT&quot;</span><span class="p">),</span>
        <span class="s2">&quot;INTEG&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="n">global_msids</span><span class="p">[</span><span class="s2">&quot;integration_time&quot;</span><span class="p">]]),</span>
        <span class="s2">&quot;GLBSTAT&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="n">global_msids</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]]),</span>
        <span class="s2">&quot;HIGH_BGD&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">glbstat_bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="s2">&quot;RAM_FAIL&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">glbstat_bits</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="s2">&quot;ROM_FAIL&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">glbstat_bits</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
        <span class="s2">&quot;POWER_FAIL&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">glbstat_bits</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
        <span class="s2">&quot;CAL_FAIL&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">glbstat_bits</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span>
        <span class="s2">&quot;COMM_CHECKSUM_FAIL&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">glbstat_bits</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span>
        <span class="s2">&quot;RESET&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">glbstat_bits</span><span class="p">[</span><span class="mi">6</span><span class="p">]),</span>
        <span class="s2">&quot;SYNTAX_ERROR&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">glbstat_bits</span><span class="p">[</span><span class="mi">7</span><span class="p">]),</span>
        <span class="s2">&quot;COMMCNT&quot;</span><span class="p">:</span> <span class="n">_packbits</span><span class="p">(</span><span class="n">comm_count_bits</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">]),</span>
        <span class="s2">&quot;COMMCNT_SYNTAX_ERROR&quot;</span><span class="p">:</span> <span class="n">comm_count_bits</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
        <span class="s2">&quot;COMMCNT_CHECKSUM_FAIL&quot;</span><span class="p">:</span> <span class="n">comm_count_bits</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
        <span class="s2">&quot;COMMPROG&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="n">global_msids</span><span class="p">[</span><span class="s2">&quot;cmd_progress_to_go&quot;</span><span class="p">]]),</span>
        <span class="s2">&quot;COMMPROG_REPEAT&quot;</span><span class="p">:</span> <span class="n">_packbits</span><span class="p">(</span><span class="n">comm_prog_bits</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">]),</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;IMGTYPE&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
        <span class="n">imgstat_bits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">blob</span><span class="p">[</span><span class="n">slot_msids</span><span class="p">[</span><span class="s2">&quot;saturated_pixel&quot;</span><span class="p">]],</span>
                <span class="n">blob</span><span class="p">[</span><span class="n">slot_msids</span><span class="p">[</span><span class="s2">&quot;defective_pixel&quot;</span><span class="p">]],</span>
                <span class="n">blob</span><span class="p">[</span><span class="n">slot_msids</span><span class="p">[</span><span class="s2">&quot;quad_bound&quot;</span><span class="p">]],</span>
                <span class="n">blob</span><span class="p">[</span><span class="n">slot_msids</span><span class="p">[</span><span class="s2">&quot;common_col&quot;</span><span class="p">]],</span>
                <span class="n">blob</span><span class="p">[</span><span class="n">slot_msids</span><span class="p">[</span><span class="s2">&quot;multi_star&quot;</span><span class="p">]],</span>
                <span class="n">blob</span><span class="p">[</span><span class="n">slot_msids</span><span class="p">[</span><span class="s2">&quot;ion_rad&quot;</span><span class="p">]],</span>
            <span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">imgstat</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_packbits</span><span class="p">(</span><span class="n">imgstat_bits</span><span class="p">))</span>

        <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;IMGFID&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span> <span class="o">==</span> <span class="n">blob</span><span class="p">[</span><span class="n">slot_msids</span><span class="p">[</span><span class="s2">&quot;fiducial_flag&quot;</span><span class="p">]],</span>
                <span class="s2">&quot;IMGNUM&quot;</span><span class="p">:</span> <span class="n">imgnum</span><span class="p">,</span>
                <span class="s2">&quot;IMGFUNC&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="n">slot_msids</span><span class="p">[</span><span class="s2">&quot;image_function&quot;</span><span class="p">]]),</span>
                <span class="s2">&quot;IMGSTAT&quot;</span><span class="p">:</span> <span class="n">imgstat</span><span class="p">,</span>
                <span class="s2">&quot;SAT_PIXEL&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="n">slot_msids</span><span class="p">[</span><span class="s2">&quot;saturated_pixel&quot;</span><span class="p">]])),</span>
                <span class="s2">&quot;DEF_PIXEL&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="n">slot_msids</span><span class="p">[</span><span class="s2">&quot;defective_pixel&quot;</span><span class="p">]])),</span>
                <span class="s2">&quot;QUAD_BOUND&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="n">slot_msids</span><span class="p">[</span><span class="s2">&quot;quad_bound&quot;</span><span class="p">]])),</span>
                <span class="s2">&quot;COMMON_COL&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="n">slot_msids</span><span class="p">[</span><span class="s2">&quot;common_col&quot;</span><span class="p">]])),</span>
                <span class="s2">&quot;MULTI_STAR&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="n">slot_msids</span><span class="p">[</span><span class="s2">&quot;multi_star&quot;</span><span class="p">]])),</span>
                <span class="s2">&quot;ION_RAD&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="n">slot_msids</span><span class="p">[</span><span class="s2">&quot;ion_rad&quot;</span><span class="p">]])),</span>
                <span class="s2">&quot;IMGROW0&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="n">slot_msids</span><span class="p">[</span><span class="s2">&quot;rows&quot;</span><span class="p">]]),</span>
                <span class="s2">&quot;IMGCOL0&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="n">slot_msids</span><span class="p">[</span><span class="s2">&quot;cols&quot;</span><span class="p">]]),</span>
                <span class="c1"># &#39;IMGSCALE&#39;: float(blob[slot_msids[&#39;scale_factor&#39;]]),  # this is scale / 32</span>
                <span class="s2">&quot;IMGSCALE&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
                    <span class="nb">float</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="n">slot_msids</span><span class="p">[</span><span class="s2">&quot;scale_factor&quot;</span><span class="p">]])</span> <span class="o">*</span> <span class="mi">32</span>
                <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
                <span class="s2">&quot;BGDAVG&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="n">slot_msids</span><span class="p">[</span><span class="s2">&quot;background_avg&quot;</span><span class="p">]]),</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;IMGTYPE&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">]:</span>
        <span class="n">bgd_stat_pixels</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="n">pixel</span><span class="p">])</span> <span class="k">for</span> <span class="n">pixel</span> <span class="ow">in</span> <span class="n">slot_msids</span><span class="p">[</span><span class="s2">&quot;bgd_stat_pixels&quot;</span><span class="p">]]</span>
        <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;BGDRMS&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="n">slot_msids</span><span class="p">[</span><span class="s2">&quot;background_rms&quot;</span><span class="p">]]),</span>
                <span class="c1"># &#39;TEMPCCD&#39;: float(blob[slot_msids[&#39;ccd_temperature&#39;]]),  # this is 0.4 * T</span>
                <span class="c1"># &#39;TEMPHOUS&#39;: float(blob[slot_msids[&#39;housing_temperature&#39;]]),  # this is 0.4 * T</span>
                <span class="c1"># &#39;TEMPPRIM&#39;: float(blob[slot_msids[&#39;primary_temperature&#39;]]),  # this is 0.4 * T</span>
                <span class="c1"># &#39;TEMPSEC&#39;: float(blob[slot_msids[&#39;secondary_temperature&#39;]]),  # this is 0.4 * T</span>
                <span class="s2">&quot;TEMPCCD&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
                    <span class="nb">float</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="n">slot_msids</span><span class="p">[</span><span class="s2">&quot;ccd_temperature&quot;</span><span class="p">]])</span> <span class="o">/</span> <span class="mf">0.4</span>
                <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
                <span class="s2">&quot;TEMPHOUS&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
                    <span class="nb">float</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="n">slot_msids</span><span class="p">[</span><span class="s2">&quot;housing_temperature&quot;</span><span class="p">]])</span> <span class="o">/</span> <span class="mf">0.4</span>
                <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
                <span class="s2">&quot;TEMPPRIM&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
                    <span class="nb">float</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="n">slot_msids</span><span class="p">[</span><span class="s2">&quot;primary_temperature&quot;</span><span class="p">]])</span> <span class="o">/</span> <span class="mf">0.4</span>
                <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
                <span class="s2">&quot;TEMPSEC&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
                    <span class="nb">float</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="n">slot_msids</span><span class="p">[</span><span class="s2">&quot;secondary_temperature&quot;</span><span class="p">]])</span> <span class="o">/</span> <span class="mf">0.4</span>
                <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
                <span class="s2">&quot;BGDSTAT&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">_packbits</span><span class="p">(</span><span class="n">bgd_stat_pixels</span><span class="p">)),</span>
                <span class="s2">&quot;BGDSTAT_PIXELS&quot;</span><span class="p">:</span> <span class="n">bgd_stat_pixels</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;IMGTYPE&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">]:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;DIAGNOSTIC&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                <span class="p">)</span>  <span class="c1"># not set, and is not used downstream yet.</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">slot_msids</span><span class="p">[</span><span class="s2">&quot;centroid_ang_y&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">blob</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;YAGS&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="n">slot_msids</span><span class="p">[</span><span class="s2">&quot;centroid_ang_y&quot;</span><span class="p">]]),</span>
                <span class="s2">&quot;ZAGS&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="n">slot_msids</span><span class="p">[</span><span class="s2">&quot;centroid_ang_z&quot;</span><span class="p">]]),</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;AOATTQT1&quot;</span> <span class="ow">in</span> <span class="n">blob</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;AOATTQT1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="s2">&quot;AOATTQT1&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s2">&quot;AOATTQT2&quot;</span> <span class="ow">in</span> <span class="n">blob</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;AOATTQT2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="s2">&quot;AOATTQT2&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s2">&quot;AOATTQT3&quot;</span> <span class="ow">in</span> <span class="n">blob</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;AOATTQT3&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="s2">&quot;AOATTQT3&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s2">&quot;AOATTQT4&quot;</span> <span class="ow">in</span> <span class="n">blob</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;AOATTQT4&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="s2">&quot;AOATTQT4&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="s2">&quot;COBSRQID&quot;</span> <span class="ow">in</span> <span class="n">blob</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;COBSRQID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="s2">&quot;COBSRQID&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">result</span>
</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2025, Smithsonian Astrophysical Observatory.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>