
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>chandra_aca.plot &#8212; chandra_aca 4.38.2 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/bootstrap-astropy.css" />
    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../_static/copybutton.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../index.html"><span id="logotext1">Ska! </span><span id="logotext2">chandra_aca</span><span id="logotext3"></span></a>
  <ul>
    
    <li><a class="home" title="Homepage" href="https://cxc.cfa.harvard.edu/mta/ASPECT/tool_doc">
        <span id="logotext1">ska</span><span id="logotext2">tools</span>
    </a></li>
    <li><a title="General Index" href="../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../index.html">chandra_aca 4.38.2 documentation</a>
	 &#187;
      </li>
      <li><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for chandra_aca.plot</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>

<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>

<span class="kn">import</span> <span class="nn">agasc</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">Quaternion</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">cxotime</span> <span class="kn">import</span> <span class="n">CxoTime</span>
<span class="kn">from</span> <span class="nn">Quaternion</span> <span class="kn">import</span> <span class="n">Quat</span>
<span class="kn">from</span> <span class="nn">Ska.quatutil</span> <span class="kn">import</span> <span class="n">radec2yagzag</span>

<span class="kn">from</span> <span class="nn">chandra_aca.planets</span> <span class="kn">import</span> <span class="n">get_planet_chandra</span><span class="p">,</span> <span class="n">get_planet_eci</span>

<span class="kn">from</span> <span class="nn">.planets</span> <span class="kn">import</span> <span class="n">GET_PLANET_ECI_ERRORS</span><span class="p">,</span> <span class="n">NoEphemerisError</span><span class="p">,</span> <span class="n">get_planet_angular_sep</span>
<span class="kn">from</span> <span class="nn">.transform</span> <span class="kn">import</span> <span class="n">eci_to_radec</span><span class="p">,</span> <span class="n">radec_to_yagzag</span><span class="p">,</span> <span class="n">yagzag_to_pixels</span>

<span class="c1"># rc definitions</span>
<span class="n">frontcolor</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span>
<span class="n">backcolor</span> <span class="o">=</span> <span class="s2">&quot;white&quot;</span>
<span class="n">rcParams</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;lines.color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">frontcolor</span>
<span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;patch.edgecolor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">frontcolor</span>
<span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;text.color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">frontcolor</span>
<span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.facecolor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backcolor</span>
<span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.edgecolor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">frontcolor</span>
<span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.labelcolor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">frontcolor</span>
<span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;xtick.color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">frontcolor</span>
<span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;ytick.color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">frontcolor</span>
<span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;grid.color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">frontcolor</span>
<span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.facecolor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backcolor</span>
<span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.edgecolor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backcolor</span>
<span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;savefig.facecolor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backcolor</span>
<span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;savefig.edgecolor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backcolor</span>

<span class="c1"># Classic grid params https://matplotlib.org/users/dflt_style_changes.html#grid-lines</span>
<span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;grid.color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;k&quot;</span>
<span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;grid.linestyle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span>
<span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;grid.linewidth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="n">BAD_STAR_COLOR</span> <span class="o">=</span> <span class="s2">&quot;tomato&quot;</span>
<span class="n">BAD_STAR_ALPHA</span> <span class="o">=</span> <span class="mf">0.75</span>
<span class="n">FAINT_STAR_COLOR</span> <span class="o">=</span> <span class="s2">&quot;lightseagreen&quot;</span>
<span class="n">FAINT_STAR_ALPHA</span> <span class="o">=</span> <span class="mf">0.75</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;plot_stars&quot;</span><span class="p">,</span> <span class="s2">&quot;plot_compass&quot;</span><span class="p">,</span> <span class="s2">&quot;bad_acq_stars&quot;</span><span class="p">]</span>


<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">custom_plt</span><span class="p">():</span>
    <span class="n">orig</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">rcParams</span><span class="p">}</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rcParams</span><span class="p">)</span>
    <span class="k">yield</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">custom_plt_rcparams</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorator to make a function use the custom rcParams plt params</span>
<span class="sd">    temporarily.  This uses a context manage to ensure original</span>
<span class="sd">    params always get restored.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">custom_plt</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapper</span>


<span class="k">def</span> <span class="nf">symsize</span><span class="p">(</span><span class="n">mag</span><span class="p">):</span>
    <span class="c1"># map mags to figsizes, defining</span>
    <span class="c1"># mag 6 as 40 and mag 11 as 3</span>
    <span class="c1"># interp should leave it at the bounding value outside</span>
    <span class="c1"># the range</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">mag</span><span class="p">,</span> <span class="p">[</span><span class="mf">6.0</span><span class="p">,</span> <span class="mf">11.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">40.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_plot_catalog_items</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">catalog</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot catalog items (guide, acq, bot, mon, fid) in yang and zang on the supplied</span>
<span class="sd">    axes object in place.</span>

<span class="sd">    :param ax: matplotlib axes</span>
<span class="sd">    :param catalog: data structure containing starcheck-style columns/attributes</span>
<span class="sd">                    catalog records.  This can be anything that will work with</span>
<span class="sd">                    astropy.table.Table(catalog).  A list of dicts is the convention.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cat</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">catalog</span><span class="p">)</span>
    <span class="n">cat</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">],</span> <span class="n">cat</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yagzag_to_pixels</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s2">&quot;yang&quot;</span><span class="p">],</span> <span class="n">cat</span><span class="p">[</span><span class="s2">&quot;zang&quot;</span><span class="p">],</span> <span class="n">allow_bad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">gui_stars</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[(</span><span class="n">cat</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;GUI&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;BOT&quot;</span><span class="p">)]</span>
    <span class="n">acq_stars</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[(</span><span class="n">cat</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ACQ&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;BOT&quot;</span><span class="p">)]</span>
    <span class="n">fids</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="n">cat</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;FID&quot;</span><span class="p">]</span>
    <span class="n">mon_wins</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="n">cat</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;MON&quot;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cat</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">],</span>
            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">120</span> <span class="o">/</span> <span class="mi">5</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">60</span> <span class="o">/</span> <span class="mi">5</span><span class="p">),</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">gui_stars</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">],</span> <span class="n">gui_stars</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">],</span> <span class="n">facecolors</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">acq_star</span> <span class="ow">in</span> <span class="n">acq_stars</span><span class="p">:</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">acq_star</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">acq_star</span><span class="p">[</span><span class="s2">&quot;halfw&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">5</span><span class="p">,</span>
                <span class="n">acq_star</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">acq_star</span><span class="p">[</span><span class="s2">&quot;halfw&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">5</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">width</span><span class="o">=</span><span class="n">acq_star</span><span class="p">[</span><span class="s2">&quot;halfw&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">5</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="n">acq_star</span><span class="p">[</span><span class="s2">&quot;halfw&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">5</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
            <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">mon_box</span> <span class="ow">in</span> <span class="n">mon_wins</span><span class="p">:</span>
        <span class="c1"># starcheck convention was to plot monitor boxes at 2X halfw</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">mon_box</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">mon_box</span><span class="p">[</span><span class="s2">&quot;halfw&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">5</span><span class="p">),</span>
                <span class="n">mon_box</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">mon_box</span><span class="p">[</span><span class="s2">&quot;halfw&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">5</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">width</span><span class="o">=</span><span class="n">mon_box</span><span class="p">[</span><span class="s2">&quot;halfw&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">5</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="n">mon_box</span><span class="p">[</span><span class="s2">&quot;halfw&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">5</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span>
            <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">fids</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">],</span>
        <span class="n">fids</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">],</span>
        <span class="n">facecolors</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
        <span class="n">edgecolors</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
        <span class="n">s</span><span class="o">=</span><span class="mi">175</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">fids</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">],</span> <span class="n">fids</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">],</span> <span class="n">facecolors</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">175</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_plot_field_stars</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">stars</span><span class="p">,</span> <span class="n">attitude</span><span class="p">,</span> <span class="n">red_mag_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bad_stars</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot plot field stars in yang and zang on the supplied</span>
<span class="sd">    axes object in place.</span>

<span class="sd">    :param ax: matplotlib axes</span>
<span class="sd">    :param stars: astropy.table compatible set of records of agasc entries of stars</span>
<span class="sd">    :param attitude: Quaternion-compatible attitude</span>
<span class="sd">    :param red_mag_lim: faint limit</span>
<span class="sd">    :param bad_stars: boolean mask of stars to be plotted in red</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stars</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">stars</span><span class="p">)</span>
    <span class="n">quat</span> <span class="o">=</span> <span class="n">Quaternion</span><span class="o">.</span><span class="n">Quat</span><span class="p">(</span><span class="n">attitude</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bad_stars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bad_stars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stars</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;yang&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stars</span><span class="o">.</span><span class="n">colnames</span> <span class="ow">or</span> <span class="s2">&quot;zang&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stars</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
        <span class="c1"># Add star Y angle and Z angle in arcsec to the stars table.</span>
        <span class="c1"># radec2yagzag returns degrees.</span>
        <span class="n">yags</span><span class="p">,</span> <span class="n">zags</span> <span class="o">=</span> <span class="n">radec2yagzag</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;RA_PMCORR&quot;</span><span class="p">],</span> <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;DEC_PMCORR&quot;</span><span class="p">],</span> <span class="n">quat</span><span class="p">)</span>
        <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;yang&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yags</span> <span class="o">*</span> <span class="mi">3600</span>
        <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;zang&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zags</span> <span class="o">*</span> <span class="mi">3600</span>

    <span class="c1"># Update table to include row/col values corresponding to yag/zag</span>
    <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">yagzag_to_pixels</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;yang&quot;</span><span class="p">],</span> <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;zang&quot;</span><span class="p">],</span> <span class="n">allow_bad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span>
    <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cols</span>

    <span class="c1"># Initialize array of colors for the stars, default is black.  Use &#39;object&#39;</span>
    <span class="c1"># type to not worry in advance about string length and also for Py2/3 compat.</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stars</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">)</span>
    <span class="n">colors</span><span class="p">[:]</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span>

    <span class="n">colors</span><span class="p">[</span><span class="n">bad_stars</span><span class="p">]</span> <span class="o">=</span> <span class="n">BAD_STAR_COLOR</span>

    <span class="k">if</span> <span class="n">red_mag_lim</span><span class="p">:</span>
        <span class="c1"># Mark stars with the FAINT_STAR_COLOR if they have MAG_ACA</span>
        <span class="c1"># that is fainter than red_mag_lim but brighter than red_mag_lim</span>
        <span class="c1"># plus a rough mag error.  The rough mag error calculation is</span>
        <span class="c1"># based on the SAUSAGE acq stage 1 check, which uses nsigma of</span>
        <span class="c1"># 3.0, a mag low limit of 1.5, and a random error of 0.26.</span>
        <span class="n">nsigma</span> <span class="o">=</span> <span class="mf">3.0</span>
        <span class="n">mag_error_low_limit</span> <span class="o">=</span> <span class="mf">1.5</span>
        <span class="n">randerr</span> <span class="o">=</span> <span class="mf">0.26</span>
        <span class="n">caterr</span> <span class="o">=</span> <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;MAG_ACA_ERR&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">100.0</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">nsigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">randerr</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">caterr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">mag_error_low_limit</span><span class="p">)</span>
        <span class="c1"># Faint and bad stars will keep their BAD_STAR_COLOR</span>
        <span class="c1"># Only use the faint mask on stars that are not bad</span>
        <span class="n">colors</span><span class="p">[</span>
            <span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;MAG_ACA&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">red_mag_lim</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;MAG_ACA&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">red_mag_lim</span> <span class="o">+</span> <span class="n">error</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="o">~</span><span class="n">bad_stars</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">FAINT_STAR_COLOR</span>
        <span class="c1"># Don&#39;t plot those for which MAG_ACA is fainter than red_mag_lim + error</span>
        <span class="c1"># This overrides any that may be &#39;bad&#39;</span>
        <span class="n">colors</span><span class="p">[</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;MAG_ACA&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">red_mag_lim</span> <span class="o">+</span> <span class="n">error</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>

    <span class="n">size</span> <span class="o">=</span> <span class="n">symsize</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;MAG_ACA&quot;</span><span class="p">])</span>
    <span class="c1"># scatter() does not take an array of alphas, and rgba is</span>
    <span class="c1"># awkward for color=&#39;none&#39;, so plot these in a loop.</span>
    <span class="k">for</span> <span class="n">color</span><span class="p">,</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">FAINT_STAR_COLOR</span><span class="p">,</span> <span class="n">FAINT_STAR_ALPHA</span><span class="p">),</span>
        <span class="p">(</span><span class="n">BAD_STAR_COLOR</span><span class="p">,</span> <span class="n">BAD_STAR_ALPHA</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
    <span class="p">]:</span>
        <span class="n">colormatch</span> <span class="o">=</span> <span class="n">colors</span> <span class="o">==</span> <span class="n">color</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">stars</span><span class="p">[</span><span class="n">colormatch</span><span class="p">][</span><span class="s2">&quot;row&quot;</span><span class="p">],</span>
            <span class="n">stars</span><span class="p">[</span><span class="n">colormatch</span><span class="p">][</span><span class="s2">&quot;col&quot;</span><span class="p">],</span>
            <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="n">size</span><span class="p">[</span><span class="n">colormatch</span><span class="p">],</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
        <span class="p">)</span>


<div class="viewcode-block" id="plot_stars"><a class="viewcode-back" href="../../index.html#chandra_aca.plot.plot_stars">[docs]</a><span class="nd">@custom_plt_rcparams</span>
<span class="k">def</span> <span class="nf">plot_stars</span><span class="p">(</span>
    <span class="n">attitude</span><span class="p">,</span>
    <span class="n">catalog</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">stars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">starcat_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">red_mag_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">quad_bound</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">grid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">bad_stars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">plot_keepout</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">duration</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot a catalog, a star field, or both in a matplotlib figure.</span>
<span class="sd">    If supplying a star field, an attitude must also be supplied.</span>

<span class="sd">    :param attitude: A Quaternion compatible attitude for the pointing</span>
<span class="sd">    :param catalog: Records describing catalog.  Must be astropy table compatible.</span>
<span class="sd">        Required fields are [&#39;idx&#39;, &#39;type&#39;, &#39;yang&#39;, &#39;zang&#39;, &#39;halfw&#39;]</span>
<span class="sd">    :param stars: astropy table compatible set of agasc records of stars</span>
<span class="sd">        Required fields are [&#39;RA_PMCORR&#39;, &#39;DEC_PMCORR&#39;, &#39;MAG_ACA&#39;, &#39;MAG_ACA_ERR&#39;].</span>
<span class="sd">        If bad_acq_stars will be called (bad_stars is None), additional required fields</span>
<span class="sd">        [&#39;CLASS&#39;, &#39;ASPQ1&#39;, &#39;ASPQ2&#39;, &#39;ASPQ3&#39;, &#39;VAR&#39;, &#39;POS_ERR&#39;]</span>
<span class="sd">        If stars is None, stars will be fetched from the AGASC for the</span>
<span class="sd">        supplied attitude.</span>
<span class="sd">    :param title: string to be used as suptitle for the figure</span>
<span class="sd">    :param starcat_time: DateTime-compatible time.  Used in ACASC fetch for proper</span>
<span class="sd">        motion correction.  Not used if stars is not None.</span>
<span class="sd">    :param red_mag_lim: faint limit for field star plotting.</span>
<span class="sd">    :param quad_bound: boolean, plot inner quadrant boundaries</span>
<span class="sd">    :param grid: boolean, plot axis grid</span>
<span class="sd">    :param bad_stars: boolean mask on &#39;stars&#39; of those that don&#39;t meet minimum requirements</span>
<span class="sd">        to be selected as acq stars.  If None, bad_stars will be set by a call</span>
<span class="sd">        to bad_acq_stars().</span>
<span class="sd">    :param plot_keepout: plot CCD area to be avoided in star selection (default=False)</span>
<span class="sd">    :param ax: matplotlib axes object to use (optional)</span>
<span class="sd">    :param duration: duration (starting at ``starcat_time``) for plotting planets</span>
<span class="sd">        (secs, default=0)</span>
<span class="sd">    :returns: matplotlib figure</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">stars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">quat</span> <span class="o">=</span> <span class="n">Quaternion</span><span class="o">.</span><span class="n">Quat</span><span class="p">(</span><span class="n">attitude</span><span class="p">)</span>
        <span class="n">stars</span> <span class="o">=</span> <span class="n">agasc</span><span class="o">.</span><span class="n">get_agasc_cone</span><span class="p">(</span><span class="n">quat</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">quat</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">starcat_time</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bad_stars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bad_stars</span> <span class="o">=</span> <span class="n">bad_acq_stars</span><span class="p">(</span><span class="n">stars</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">5.325</span><span class="p">,</span> <span class="mf">5.325</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>

        <span class="c1"># Make an empty plot in row, col space</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
    <span class="n">lim0</span><span class="p">,</span> <span class="n">lim1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">580</span><span class="p">,</span> <span class="mi">590</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">lim0</span><span class="p">,</span> <span class="n">lim1</span><span class="p">)</span>  <span class="c1"># Matches -2900, 2900 arcsec roughly</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">lim0</span><span class="p">,</span> <span class="n">lim1</span><span class="p">)</span>

    <span class="c1"># plot the box and set the labels</span>
    <span class="n">b1hw</span> <span class="o">=</span> <span class="mi">512</span>
    <span class="n">box1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">b1hw</span><span class="p">,</span> <span class="o">-</span><span class="n">b1hw</span><span class="p">),</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">b1hw</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">b1hw</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">box1</span><span class="p">)</span>
    <span class="n">b2w</span> <span class="o">=</span> <span class="mi">520</span>
    <span class="n">box2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">b2w</span><span class="p">,</span> <span class="o">-</span><span class="n">b1hw</span><span class="p">),</span> <span class="o">-</span><span class="mi">4</span> <span class="o">+</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">b2w</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">b1hw</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">box2</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">2700</span><span class="p">,</span> <span class="o">-</span><span class="mi">2700</span><span class="p">,</span> <span class="o">-</span><span class="mi">2700</span><span class="p">,</span> <span class="o">-</span><span class="mi">2700</span><span class="p">,</span> <span class="o">-</span><span class="mi">2700</span><span class="p">])</span> <span class="o">/</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2400</span><span class="p">,</span> <span class="mi">2100</span><span class="p">,</span> <span class="mi">1800</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="mi">1200</span><span class="p">])</span> <span class="o">/</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">c</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span>
        <span class="n">edgecolors</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
        <span class="n">s</span><span class="o">=</span><span class="n">symsize</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">9.0</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">])),</span>
    <span class="p">)</span>

    <span class="c1"># Manually set ticks and grid to specified yag/zag values</span>
    <span class="n">yz_ticks</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">2000</span><span class="p">,</span> <span class="o">-</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">]</span>
    <span class="n">zeros</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">r</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">yagzag_to_pixels</span><span class="p">(</span><span class="n">yz_ticks</span><span class="p">,</span> <span class="n">zeros</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">yz_ticks</span><span class="p">)</span>
    <span class="n">r</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">yagzag_to_pixels</span><span class="p">(</span><span class="n">zeros</span><span class="p">,</span> <span class="n">yz_ticks</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">yz_ticks</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Yag (arcsec)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Zag (arcsec)&quot;</span><span class="p">)</span>
    <span class="p">[</span><span class="n">label</span><span class="o">.</span><span class="n">set_rotation</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()]</span>

    <span class="k">if</span> <span class="n">quad_bound</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="mi">511</span><span class="p">,</span> <span class="mi">511</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;magenta&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">511</span><span class="p">,</span> <span class="mi">511</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;magenta&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_keepout</span><span class="p">:</span>
        <span class="c1"># Plot grey area showing effective keep-out zones for stars.  Back off on</span>
        <span class="c1"># outer limits by one pixel to improve rendered PNG slightly.</span>
        <span class="n">row_pad</span> <span class="o">=</span> <span class="mi">15</span>
        <span class="n">col_pad</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
            <span class="p">(</span><span class="o">-</span><span class="mi">511</span><span class="p">,</span> <span class="o">-</span><span class="mi">511</span><span class="p">),</span>
            <span class="mi">1022</span><span class="p">,</span>
            <span class="mi">1022</span><span class="p">,</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
            <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
            <span class="n">zorder</span><span class="o">=-</span><span class="mi">1000</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
            <span class="p">(</span><span class="o">-</span><span class="mi">512</span> <span class="o">+</span> <span class="n">row_pad</span><span class="p">,</span> <span class="o">-</span><span class="mi">512</span> <span class="o">+</span> <span class="n">col_pad</span><span class="p">),</span>
            <span class="mi">1024</span> <span class="o">-</span> <span class="n">row_pad</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
            <span class="mi">1024</span> <span class="o">-</span> <span class="n">col_pad</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
            <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
            <span class="n">zorder</span><span class="o">=-</span><span class="mi">999</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>

    <span class="c1"># Plot stars</span>
    <span class="n">_plot_field_stars</span><span class="p">(</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">stars</span><span class="p">,</span> <span class="n">attitude</span><span class="o">=</span><span class="n">attitude</span><span class="p">,</span> <span class="n">bad_stars</span><span class="o">=</span><span class="n">bad_stars</span><span class="p">,</span> <span class="n">red_mag_lim</span><span class="o">=</span><span class="n">red_mag_lim</span>
    <span class="p">)</span>

    <span class="c1"># plot starcheck catalog</span>
    <span class="k">if</span> <span class="n">catalog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_plot_catalog_items</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">catalog</span><span class="p">)</span>

    <span class="c1"># Planets</span>
    <span class="n">_plot_planets</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">attitude</span><span class="p">,</span> <span class="n">starcat_time</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">lim0</span><span class="p">,</span> <span class="n">lim1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;small&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<span class="k">def</span> <span class="nf">_plot_planets</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">att</span><span class="p">,</span> <span class="n">date0</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">lim0</span><span class="p">,</span> <span class="n">lim1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param ax: plt.Axes</span>
<span class="sd">        Matplotlib axes object to use</span>
<span class="sd">    :param att: Quat</span>
<span class="sd">        Attitude quaternion</span>
<span class="sd">    :param date0: CxoTime-compatible</span>
<span class="sd">        Date of obs start</span>
<span class="sd">    :param duration: float</span>
<span class="sd">        Duration of plot (secs)</span>
<span class="sd">    :param lim0: float</span>
<span class="sd">        Lower limit on x, y axis (row)</span>
<span class="sd">    :param lim1: float</span>
<span class="sd">        Upper limit on x, y axis (col)</span>

<span class="sd">    :returns: boolean</span>
<span class="sd">        True if planets were plotted</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="n">Quat</span><span class="p">):</span>
        <span class="n">att</span> <span class="o">=</span> <span class="n">Quat</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>

    <span class="n">date0</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">date0</span><span class="p">)</span>
    <span class="n">n_times</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">duration</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">dates</span> <span class="o">=</span> <span class="n">date0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">n_times</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span>

    <span class="n">planets</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;venus&quot;</span><span class="p">,</span> <span class="s2">&quot;mars&quot;</span><span class="p">,</span> <span class="s2">&quot;jupiter&quot;</span><span class="p">,</span> <span class="s2">&quot;saturn&quot;</span><span class="p">)</span>
    <span class="n">has_planet</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">for</span> <span class="n">planet</span> <span class="ow">in</span> <span class="n">planets</span><span class="p">:</span>
        <span class="c1"># First check if planet is within 2 deg of aimpoint using Earth as the</span>
        <span class="c1"># reference point (without fetching Chandra ephemeris). These values are</span>
        <span class="c1"># accurate to better than 0.25 deg.</span>
        <span class="n">sep</span> <span class="o">=</span> <span class="n">get_planet_angular_sep</span><span class="p">(</span>
            <span class="n">planet</span><span class="p">,</span>
            <span class="n">ra</span><span class="o">=</span><span class="n">att</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span>
            <span class="n">dec</span><span class="o">=</span><span class="n">att</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span>
            <span class="n">time</span><span class="o">=</span><span class="n">date0</span> <span class="o">+</span> <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span> <span class="o">*</span> <span class="n">duration</span><span class="p">,</span>
            <span class="n">observer_position</span><span class="o">=</span><span class="s2">&quot;earth&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">sep</span> <span class="o">&gt;</span> <span class="mf">2.0</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="c1"># Compute ACA row, col for planet each ksec (approx) over the duration.</span>
        <span class="c1"># This uses get_planet_chandra which is accurate to 4 arcsec for Venus</span>
        <span class="c1"># and &lt; 1 arcsec for Jupiter, Saturn.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">eci</span> <span class="o">=</span> <span class="n">get_planet_chandra</span><span class="p">(</span><span class="n">planet</span><span class="p">,</span> <span class="n">dates</span><span class="p">)</span>
            <span class="n">from_earth</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="n">NoEphemerisError</span><span class="p">:</span>
            <span class="c1"># Get the position from Earth using built-in DE432</span>
            <span class="n">eci</span> <span class="o">=</span> <span class="n">get_planet_eci</span><span class="p">(</span><span class="n">planet</span><span class="p">,</span> <span class="n">dates</span><span class="p">)</span>
            <span class="n">from_earth</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">eci_to_radec</span><span class="p">(</span><span class="n">eci</span><span class="p">)</span>
        <span class="n">yag</span><span class="p">,</span> <span class="n">zag</span> <span class="o">=</span> <span class="n">radec_to_yagzag</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">att</span><span class="p">)</span>
        <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">yagzag_to_pixels</span><span class="p">(</span><span class="n">yag</span><span class="p">,</span> <span class="n">zag</span><span class="p">,</span> <span class="n">allow_bad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Only plot planet within the image limits</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">row</span> <span class="o">&gt;=</span> <span class="n">lim0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">row</span> <span class="o">&lt;=</span> <span class="n">lim1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">col</span> <span class="o">&gt;=</span> <span class="n">lim0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">col</span> <span class="o">&lt;=</span> <span class="n">lim1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ok</span><span class="p">):</span>
            <span class="n">has_planet</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span>
            <span class="c1"># Plot with green at beginning, red at ending</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">planet</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">from_earth</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">GET_PLANET_ECI_ERRORS</span><span class="p">[</span><span class="n">planet</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span>
                <span class="n">label</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; (from Earth, errors to </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">)&quot;</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">col</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">has_planet</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;small&quot;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="bad_acq_stars"><a class="viewcode-back" href="../../index.html#chandra_aca.plot.bad_acq_stars">[docs]</a><span class="k">def</span> <span class="nf">bad_acq_stars</span><span class="p">(</span><span class="n">stars</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return mask of &#39;bad&#39; stars, by evaluating AGASC star parameters.</span>

<span class="sd">    :param stars: astropy table-compatible set of agasc records of stars. Required fields</span>
<span class="sd">          are [&#39;CLASS&#39;, &#39;ASPQ1&#39;, &#39;ASPQ2&#39;, &#39;ASPQ3&#39;, &#39;VAR&#39;, &#39;POS_ERR&#39;]</span>
<span class="sd">    :returns: boolean mask true for &#39;bad&#39; stars</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;CLASS&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="o">|</span> <span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;MAG_ACA_ERR&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
        <span class="o">|</span> <span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;POS_ERR&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3000</span><span class="p">)</span>
        <span class="o">|</span> <span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;ASPQ1&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="o">|</span> <span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;ASPQ2&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="o">|</span> <span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;ASPQ3&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">999</span><span class="p">)</span>
        <span class="o">|</span> <span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;VAR&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">9999</span><span class="p">)</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="plot_compass"><a class="viewcode-back" href="../../index.html#chandra_aca.plot.plot_compass">[docs]</a><span class="nd">@custom_plt_rcparams</span>
<span class="k">def</span> <span class="nf">plot_compass</span><span class="p">(</span><span class="n">roll</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make a compass plot.</span>

<span class="sd">    :param roll: Attitude roll for compass plot.</span>
<span class="sd">    :returns: matplotlib figure</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">polar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;&lt;-&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">90</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;&lt;-&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&quot;E&quot;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">90</span><span class="p">),</span> <span class="mf">1.2</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_theta_offset</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">90</span> <span class="o">+</span> <span class="n">roll</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


<form action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2015, Tom Aldcroft, Jean Connelly.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 4.2.0. &nbsp;
  </p>
</footer>
  </body>
</html>